<!-- v26 -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Celeb Slideshow ‚Äî Random Photo Fetcher (v26)</title>
<meta name="description" content="Swipe pages, auto-fetch from Wikidata/Commons, random mixing, edit tiles, clear-all, seamless centered images. No blue FAB; use the gear for Settings." />
<style>
  :root { --bg:#0b0f14; --panel:#0f172a; --muted:#93a3b8; --fg:#e5eef7; --accent:#60a5fa; --ok:#34d399; --danger:#f87171; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; background:var(--bg); color:var(--fg); display:grid; grid-template-rows:auto auto 1fr auto}

  header{display:flex; gap:10px; align-items:center; padding:10px 12px; position:sticky; top:0; z-index:100; background:#0b0f14; border-bottom:1px solid rgba(255,255,255,.06)}
  h1{font-size:16px; margin:0}
  .sp{flex:1}
  .iconBtn{height:36px; padding:0 12px; display:inline-grid; place-items:center; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); cursor:pointer; color:#fff}
  .badge{font-size:12px; padding:4px 8px; border:1px solid rgba(255,255,255,.12); border-radius:999px}

  .tabs{position:sticky; top:52px; z-index:99; display:flex; gap:8px; padding:8px 12px; border-bottom:1px solid rgba(255,255,255,.06); background:#0b0f14; overflow:auto}
  .tab{padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.1); cursor:pointer; white-space:nowrap}
  .tab[aria-selected="true"]{background:rgba(96,165,250,.15); border-color:rgba(96,165,250,.6)}
  .page{display:none; height:100%}
  .page.active{display:block}

  /* Layout: left rail + stage */
  .stageWrap{position:relative; height:calc(100vh - 210px); min-height:360px; display:grid; grid-template-columns:88px 1fr; gap:0; overflow:hidden}
  .leftRail{position:relative; display:grid; grid-auto-rows:min-content; gap:12px; padding:12px 8px; background:linear-gradient(90deg, rgba(59,130,246,.20), rgba(59,130,246,.06)); border-right:1px solid rgba(255,255,255,.06); z-index:5}
  .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:#e5eef7; cursor:pointer; font-weight:700}
  .btn.primary{border-color:rgba(96,165,250,.6); background:rgba(96,165,250,.15)}
  .btn.ok{border-color:rgba(52,211,153,.6); background:rgba(52,211,153,.15)}
  .btn.danger{border-color:rgba(248,113,113,.7); background:rgba(248,113,113,.18)}
  .btn.playing{border-color:rgba(52,211,153,.9); background:rgba(52,211,153,.3)}
  .railBtnTall{height:120px; white-space:normal; line-height:1.1}

  .stage{position:relative; overflow:hidden; display:grid; place-items:center}
  .imgwrap{position:relative; width:100%; height:100%; display:grid; place-items:center; overflow:hidden}
  img.photo{max-width:88vw; max-height:72vh; object-fit:contain; border-radius:18px; box-shadow:0 12px 36px rgba(0,0,0,.6); opacity:0; transition:opacity .18s ease}
  img.photo.show{opacity:1}

  /* Click zones */
  .hotzone{position:absolute; top:0; bottom:0; z-index:2}
  .hotzone.left{left:0; width:33.333%}
  .hotzone.right{right:0; width:66.667%}

  /* Name overlay (bottom ~30%) */
  .nameOverlay{position:absolute; left:50%; bottom:6%; transform:translateX(-50%); width:min(92%, 820px);
    background:linear-gradient(180deg, rgba(2,6,23,0), rgba(2,6,23,.92));
    border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:14px 16px; text-align:center}
  .nameOverlay.collapsed{display:none}
  .title{font-size:22px; font-weight:800}

  .linkTopRight{position:fixed; right:16px; top:100px; z-index:98; border-radius:10px; height:32px; padding:0 10px}

  .builder{padding:12px}
  .hint{font-size:13px; color:var(--muted); margin:6px 0 10px}
  .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(160px, 1fr)); gap:10px}
  .termBtn{position:relative; padding:12px 14px; border-radius:12px; background:#111827; border:1px solid rgba(255,255,255,.22); cursor:pointer; text-align:left; user-select:none; color:#fff}
  .termBtn.selected{outline:2px solid var(--accent); background:#1f2937}
  .termBtn.editing{outline:2px dashed #fbbf24}

  .builderActions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; align-items:center}

  footer{padding:10px 12px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; color:#a9b6c7; border-top:1px solid rgba(255,255,255,.06)}
  footer a{color:#86efac; text-decoration:none}

  @media (max-width: 768px){
    .stageWrap{grid-template-columns:76px 1fr}
    img.photo{max-width:92vw; max-height:66vh}
    .linkTopRight{top:96px}
  }
</style>
</head>
<body>
<header>
  <h1>üéûÔ∏è Celeb Slideshow</h1>
  <span class="badge" id="countBadge">‚Äî</span>
  <div class="sp"></div>
  <button class="iconBtn" id="gearBtn" title="Settings (toggle)">‚öôÔ∏è</button>
  <button class="iconBtn" id="nextTabBtn" title="Next page">‚û°Ô∏è</button>
</header>

<nav class="tabs" role="tablist" id="tabsBar">
  <button class="tab" role="tab" aria-controls="page1" aria-selected="true" id="tab1">Page 1: Slideshow</button>
  <button class="tab" role="tab" aria-controls="page2" aria-selected="false" id="tab2">Page 2: Categories A</button>
  <button class="tab" role="tab" aria-controls="page3" aria-selected="false" id="tab3">Page 3: Categories B</button>
  <button class="tab" role="tab" aria-controls="page4" aria-selected="false" id="tab4">Page 4: Categories C</button>
  <button class="tab" role="tab" aria-controls="page5" aria-selected="false" id="tab5">Page 5: Settings</button>
</nav>

<button class="iconBtn linkTopRight" id="openLinkHeader" title="Open related page">üîó Link</button>

<main>
  <!-- PAGE 1 -->
  <section id="page1" class="page active" role="tabpanel" aria-labelledby="tab1">
    <div class="stageWrap">
      <div class="leftRail">
        <button class="btn" id="hideAllNames">Hide</button>
        <button class="btn primary railBtnTall" id="cornerPlayStop">‚èØÔ∏è</button>
        <button class="btn railBtnTall" id="showThisName">Show</button>
        <button class="btn railBtnTall" id="nextPhoto">Next</button>
      </div>
      <div class="stage" id="stage">
        <div class="imgwrap" id="imgwrap"><div class="hint" style="opacity:.7">Fetching photos‚Ä¶</div></div>
        <div class="hotzone left" id="zoneLeft" title="Previous"></div>
        <div class="hotzone right" id="zoneRight" title="Next"></div>
        <div class="nameOverlay collapsed" id="nameOverlay"><div class="title" id="entityName">&nbsp;</div></div>
      </div>
    </div>
  </section>

  <!-- PAGE 2 -->
  <section id="page2" class="page" role="tabpanel" aria-labelledby="tab2">
    <div class="builder">
      <div class="hint">Tap to select (blue). <strong>Triple-click</strong> (or long-press) to rename. Use <em>Clear ALL</em> to empty selection.</div>
      <div class="grid" id="termGrid1"></div>
      <div class="builderActions">
        <input type="text" id="customTerm1" placeholder="Add a custom term‚Ä¶ (e.g., cars of 2010)" />
        <button class="btn ok" id="addTerm1">Add</button>
        <div class="sp"></div>
        <button class="btn danger" id="clearAllSelBtn1" title="Alt+C">Clear ALL</button>
      </div>
    </div>
  </section>

  <!-- PAGE 3 -->
  <section id="page3" class="page" role="tabpanel" aria-labelledby="tab3">
    <div class="builder">
      <div class="hint">Tap to select (blue). <strong>Triple-click</strong> (or long-press) to rename. Use <em>Clear ALL</em> to empty selection.</div>
      <div class="grid" id="termGrid2"></div>
      <div class="builderActions">
        <input type="text" id="customTerm2" placeholder="Add a custom term‚Ä¶" />
        <button class="btn ok" id="addTerm2">Add</button>
        <div class="sp"></div>
        <button class="btn danger" id="clearAllSelBtn2" title="Alt+C">Clear ALL</button>
      </div>
    </div>
  </section>

  <!-- PAGE 4 -->
  <section id="page4" class="page" role="tabpanel" aria-labelledby="tab4">
    <div class="builder">
      <div class="hint">Tap to select (blue). <strong>Triple-click</strong> (or long-press) to rename. Use <em>Clear ALL</em> to empty selection.</div>
      <div class="grid" id="termGrid3"></div>
      <div class="builderActions">
        <input type="text" id="customTerm3" placeholder="Add a custom term‚Ä¶" />
        <button class="btn ok" id="addTerm3">Add</button>
        <div class="sp"></div>
        <button class="btn danger" id="clearAllSelBtn3" title="Alt+C">Clear ALL</button>
      </div>
    </div>
  </section>

  <!-- PAGE 5 (Settings) -->
  <section id="page5" class="page" role="tabpanel" aria-labelledby="tab5">
    <div class="builder" style="max-width:880px">
      <div class="hint">Timing controls. Tap the ‚öôÔ∏è gear again to exit Settings.</div>
      <div style="display:grid; gap:14px; padding:8px; background:#0f172a; border:1px solid rgba(255,255,255,.08); border-radius:12px">
        <div><strong>Slide speed</strong> <span class="hint">(¬±1s / ¬±0.2s steps)</span></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
          <button class="btn" data-speed="-1">‚àí1s</button>
          <button class="btn" data-speed="+1">Ôºã1s</button>
          <button class="btn" data-speed="-0.2">‚àí0.2s</button>
          <button class="btn" data-speed="+0.2">Ôºã0.2s</button>
          <div style="margin-left:auto"><span class="hint">Total:</span> <strong id="fineTotal">2.0s</strong></div>
        </div>

        <div><strong>Name reveal delay</strong> <span class="hint">(¬±1s / ¬±0.2s steps)</span></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
          <button class="btn" data-nd="-1">‚àí1s</button>
          <button class="btn" data-nd="+1">Ôºã1s</button>
          <button class="btn" data-nd="-0.2">‚àí0.2s</button>
          <button class="btn" data-nd="+0.2">Ôºã0.2s</button>
          <div style="margin-left:auto"><span class="hint">Total:</span> <strong id="nameTotal">0.5s</strong></div>
        </div>
      </div>

      <div style="display:grid; gap:10px; margin-top:12px">
        <button class="btn ok" id="exportBtn">Export categories ‚Üí JSON</button>
        <textarea id="jsonBox" placeholder='Paste JSON here to import‚Ä¶' style="height:160px; width:100%; background:#0b1220; color:#e5eef7; border:1px solid rgba(255,255,255,.1); border-radius:10px; padding:10px"></textarea>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn ok" id="importBtn">Import JSON</button>
          <button class="btn" id="resetBtn">Reset to defaults</button>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>
  <div>PC: On <strong>Pages 2‚Äì5</strong> use <kbd>‚Üí</kbd>/<kbd>‚Üê</kbd> to change pages. On <strong>Page 1</strong>, <kbd>‚Üí</kbd>/<kbd>‚Üê</kbd> go next/prev photo. <kbd>Alt</kbd>+<kbd>C</kbd> = Clear ALL. <kbd>Space</kbd>/<kbd>P</kbd>=play/pause. While renaming, hotkeys are disabled. Mobile: swipe left/right to switch pages.</div>
  <div class="sp"></div>
  <a href="#" id="downloadLink" title="Download current image">Download</a>
</footer>

<div class="toast" id="toast" style="display:none"></div>

<script>
(function(){
  /* ===== Tabs + swipe pages ===== */
  const tabs = [1,2,3,4,5].map(i=>({ tab: document.getElementById('tab'+i), page: document.getElementById('page'+i) }));
  function setPage(idx){
    tabs.forEach((t,i)=>{ const on=(i+1)===idx; t.page.classList.toggle('active', on); t.tab.setAttribute('aria-selected', String(on)); });
  }
  tabs.forEach((t,i)=> t.tab.addEventListener('click', ()=> setPage(i+1)));
  document.getElementById('nextTabBtn').addEventListener('click', ()=>{
    const idx = tabs.findIndex(t=> t.page.classList.contains('active')) + 1;
    setPage(idx%5 + 1);
  });
  document.getElementById('gearBtn').addEventListener('click', ()=>{
    const idx = tabs.findIndex(t=> t.page.classList.contains('active')) + 1;
    setPage(idx===5 ? 1 : 5);
  });

  function isTyping(t){ const tag=(t?.tagName||'').toLowerCase(); return tag==='input'||tag==='textarea'||t?.isContentEditable; }
  let swipeStart=null;
  document.addEventListener('touchstart', (e)=>{ if(isTyping(e.target)) return; const t=e.changedTouches[0]; swipeStart={x:t.clientX,y:t.clientY}; }, {passive:true});
  document.addEventListener('touchend', (e)=>{ if(!swipeStart || isTyping(e.target)) return; const t=e.changedTouches[0]; const dx=t.clientX-swipeStart.x; const dy=t.clientY-swipeStart.y; if(Math.abs(dx)>42 && Math.abs(dy)<60){ const idx = tabs.findIndex(t=> t.page.classList.contains('active')) + 1; if(dx<0 && idx<5) setPage(idx+1); if(dx>0 && idx>1) setPage(idx-1); } swipeStart=null; }, {passive:true});

  /* ===== Slideshow elements ===== */
  const imgwrap = document.getElementById('imgwrap');
  const nameOverlay = document.getElementById('nameOverlay');
  const entityName = document.getElementById('entityName');
  const hideAllNamesBtn = document.getElementById('hideAllNames');
  const showThisNameBtn = document.getElementById('showThisName');
  const nextPhotoBtn = document.getElementById('nextPhoto');
  const cornerPlayStop = document.getElementById('cornerPlayStop');
  const openLinkHeader = document.getElementById('openLinkHeader');
  const countBadge = document.getElementById('countBadge');
  const downloadLink = document.getElementById('downloadLink');
  const toast = document.getElementById('toast');

  /* ===== Category grids ===== */
  const catGrids = [
    { grid: document.getElementById('termGrid1'), input: document.getElementById('customTerm1'), add: document.getElementById('addTerm1'), clearAllBtn: document.getElementById('clearAllSelBtn1') },
    { grid: document.getElementById('termGrid2'), input: document.getElementById('customTerm2'), add: document.getElementById('addTerm2'), clearAllBtn: document.getElementById('clearAllSelBtn2') },
    { grid: document.getElementById('termGrid3'), input: document.getElementById('customTerm3'), add: document.getElementById('addTerm3'), clearAllBtn: document.getElementById('clearAllSelBtn3') },
  ];

  /* ===== State ===== */
  let items = []; let timer=null; let autoplay=false; let currIndex=-1;
  let globalHideNames=false; let perSlideReveal=false; let currentLink='#';
  let slideSeconds = 2.0; let nameDelay = 500;

  function showToast(msg, ms=1200){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=> toast.style.display='none', ms); }
  function clampStep(x){ return Math.round(x*5)/5; } // 0.2s steps

  /* ===== Build & manage category tiles ===== */
  function makeTermButton(label, gridEl){
    const btn=document.createElement('button');
    btn.type='button'; btn.className='termBtn'; btn.textContent=label; btn.dataset.term=label;

    // triple-click for rename + normal select toggle
    let clicks=0, cTimer=null;
    btn.addEventListener('click', ()=>{
      clicks++;
      if(clicks>=3){ clearTimeout(cTimer); clicks=0; startEdit(btn); return; }
      clearTimeout(cTimer);
      cTimer=setTimeout(()=>{ clicks=0; btn.classList.toggle('selected'); debouncedApply(); }, 220);
    });

    // long-press rename (mobile)
    let pTimer=null;
    btn.addEventListener('touchstart', ()=>{ pTimer=setTimeout(()=> startEdit(btn), 600); }, {passive:true});
    ['touchend','touchmove','touchcancel'].forEach(ev=> btn.addEventListener(ev, ()=> clearTimeout(pTimer), {passive:true}));

    function startEdit(button){
      if(button.classList.contains('editing')) return;
      button.classList.add('editing');
      const prev = button.dataset.term || button.textContent.trim();
      const input = document.createElement('input');
      input.type='text'; input.value=prev;
      input.style.width='100%'; input.style.padding='8px 10px';
      input.style.borderRadius='8px'; input.style.border='1px solid rgba(255,255,255,.25)';
      input.style.background='#0f172a'; input.style.color='#e5eef7';
      button.innerHTML=''; button.appendChild(input); input.focus(); input.select();
      function finish(save){
        const v = save ? (input.value.trim()||prev) : prev;
        button.classList.remove('editing'); button.innerHTML=''; button.dataset.term=v; button.textContent=v;
        debouncedApply();
      }
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') finish(true); if(e.key==='Escape') finish(false); });
      input.addEventListener('blur', ()=> finish(true));
    }

    gridEl.appendChild(btn);
    return btn;
  }

  function ensureMinTiles(){ const total = catGrids.reduce((n,g)=> n + g.grid.querySelectorAll('.termBtn').length, 0); for(let i=total;i<48;i++){ const gi=Math.min(Math.floor(i/16), catGrids.length-1); makeTermButton('Custom term', catGrids[gi].grid); } }
  function attachAddHandlers(){
    catGrids.forEach(g=>{
      if(g.add){ g.add.onclick = ()=>{ const t=(g.input.value||'').trim(); if(!t) return;
        const count=g.grid.querySelectorAll('.termBtn').length;
        if(count>=16){ const nextIndex=catGrids.indexOf(g)+1; makeTermButton(t, catGrids[Math.min(nextIndex, catGrids.length-1)].grid); }
        else { makeTermButton(t, g.grid); }
        g.input.value='';
      }; }
      g.clearAllBtn.addEventListener('click', clearAllSelections);
    });
  }

  function populateDefaults(){
    catGrids.forEach(g=> g.grid.innerHTML='');
    const presets = [
      'Norwegian celebs','US celebs','Norwegian politicians','Norwegian ceo','US ceo','World ceo','Music producers',
      "Models of the 50's","Models of the 80's",'famous movie characters','famous cartoon characters',
      'objects','household objects','clutter home objects','cars','cars of 2010','cars of 2025',
      'Norwegian actors','Norwegian musicians','Norwegian writers','UK celebrity','British actors',
      'actors 2025','singers 2024','bands 2024','scientists','historical figures in science','historical leaders','historical pioneers'
    ];
    presets.forEach((p,i)=>{ const gi=Math.min(Math.floor(i/16), catGrids.length-1); makeTermButton(p, catGrids[gi].grid); });
    ensureMinTiles(); attachAddHandlers();
  }

  /* ===== Wikidata queries ===== */
  function H(lines){ return `{ ?person wdt:P31 wd:Q5 ; ${lines.join(' ')} wdt:P18 ?image . BIND(?person AS ?entity) }`; }
  function F(lines){ return `{ ?person wdt:P18 ?image . ${lines.join(' ')} BIND(?person AS ?entity) }`; }
  function T(lines){ return `{ ?thing ${lines.join(' ')} wdt:P18 ?image . BIND(?thing AS ?entity) }`; }

  const CATEGORY_BLOCK
