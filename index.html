<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Celeb Slideshow ‚Äî Random Photo Fetcher</title>
  <meta name="description" content="Slideshow that auto‚Äëfetches celebrity photos from Wikidata/Commons with reliable fetch, mobile swipe/page controls, left/middle/right click zones, top play/stop, 4 category pages (16 per), JSON import/export of categories, and a compact instruction toggle." />
  <style>
    :root { --bg:#0b0f14; --panel:#0f172a; --muted:#93a3b8; --fg:#e5eef7; --accent:#60a5fa; --ok:#34d399; --danger:#f87171; --warn:#fbbf24; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; background:var(--bg); color:var(--fg); display:grid; grid-template-rows:auto 1fr auto}
    header{display:flex; gap:10px; align-items:center; padding:10px 12px; position:sticky; top:0; z-index:50; background:rgba(2,6,23,.6); backdrop-filter:blur(8px) saturate(1.2); border-bottom:1px solid rgba(255,255,255,.06)}
    h1{font-size:16px; margin:0}
    .sp{flex:1}
    .iconBtn{width:36px; height:36px; display:grid; place-items:center; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); cursor:pointer}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); color:var(--fg); cursor:pointer; user-select:none; font-weight:600}
    .btn.primary{border-color:rgba(96,165,250,.6); background:rgba(96,165,250,.15)}
    .btn.ok{border-color:rgba(52,211,153,.6); background:rgba(52,211,153,.15)}
    .btn.warn{border-color:rgba(251,191,36,.6); background:rgba(251,191,36,.15)}
    .btn.danger{border-color:rgba(248,113,113,.7); background:rgba(248,113,113,.18)}
    .badge{font-size:12px; padding:4px 8px; border:1px solid rgba(255,255,255,.12); border-radius:999px}
    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    label{font-size:12px; color:var(--muted)}
    input[type="range"], input[type="number"], select, input[type="text"], textarea { appearance:none; -webkit-appearance:none; color:var(--fg); background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); border-radius:10px; padding:8px 10px; font-weight:600 }
    input[type="range"]{width:160px}
    input[type="number"]{width:80px}
    textarea{width:100%; min-height:140px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px}

    .tabs{display:flex; gap:8px; padding:8px 12px; border-bottom:1px solid rgba(255,255,255,.06); background:rgba(2,6,23,.35); overflow:auto}
    .tab{padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.1); cursor:pointer; white-space:nowrap}
    .tab[aria-selected="true"]{background:rgba(96,165,250,.15); border-color:rgba(96,165,250,.6)}

    .page{display:none; height:100%}
    .page.active{display:block}

    .stage{position:relative; height:calc(100vh - 240px); min-height:360px; overflow:hidden; display:grid; place-items:center}
    .imgwrap{position:relative; width:100%; height:100%; display:grid; place-items:center}
    img.photo{max-width:85%; max-height:75%; object-fit:contain; border-radius:18px; box-shadow:0 12px 36px rgba(0,0,0,.6)}

    /* Click zones for desktop/mobile taps */
    .hotzone{position:absolute; top:0; bottom:0}
    .hotzone.left{left:0; width:33.333%}
    .hotzone.right{right:0; width:66.667%}

    /* Name/caption area centered under photo */
    .nameArea{position:absolute; left:50%; transform:translateX(-50%); bottom:24px; display:grid; gap:8px; place-items:center; width:min(92%, 820px)}
    .nameToggle{order:0; padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:#1f2a44; color:#e5eef7; font-weight:700; cursor:pointer}
    .nameBar{order:1; width:100%; background:rgba(2,6,23,.88); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px 12px; text-align:center}
    .nameBar.collapsed{display:none}
    .title{font-size:20px; font-weight:800}
    .caption{font-size:13px; color:var(--muted)}

    .builder{padding:12px}
    .hintRow{display:flex; gap:10px; align-items:center; margin-bottom:8px}
    .hint{font-size:13px; color:var(--muted)}
    .hintToggle{width:18px; height:18px; border-radius:4px; background:#334155; border:1px solid rgba(255,255,255,.2); cursor:pointer}

    .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(160px, 1fr)); gap:10px}
    .termBtn{padding:12px 14px; border-radius:12px; background:#111827; border:1px solid rgba(255,255,255,.22); cursor:pointer; text-align:left; user-select:none; color:#fff}
    .termBtn.selected{outline:2px solid var(--accent); background:#1f2937}
    .termBtn.editing{outline:2px dashed var(--warn)}

    .builderActions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; align-items:center}

    footer{padding:10px 12px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; color:var(--muted); border-top:1px solid rgba(255,255,255,.06)}
    footer a{color:var(--ok); text-decoration:none}

    .toast{position:fixed; right:16px; bottom:16px; background:rgba(2,6,23,.85); color:var(--fg); border:1px solid rgba(255,255,255,.09); padding:10px 12px; border-radius:12px; font-size:13px; display:none}

    /* Floating blue button + drawer */
    .fab{position:fixed; right:16px; bottom:16px; width:56px; height:56px; border-radius:50%; background:#3b82f6; color:white; display:grid; place-items:center; font-size:22px; cursor:pointer; box-shadow:0 10px 24px rgba(0,0,0,.35); z-index:60}
    .drawer{position:fixed; left:0; right:0; bottom:-140px; background:rgba(15,23,42,.96); border-top:1px solid rgba(255,255,255,.08); padding:12px; display:grid; gap:10px; transition:bottom .25s ease; z-index:55}
    .drawer.open{bottom:0}
    .quickRow{display:flex; gap:8px; flex-wrap:wrap}
    .quickBtn{padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); color:#e5eef7; cursor:pointer; font-weight:700}

    .debug{position:fixed; left:12px; bottom:12px; font-size:11px; color:#9fb7d6; opacity:.7}

    @media (max-width: 768px){
      .controls .btn, .controls label{display:none} /* compact header on mobile */
    }
  </style>
</head>
<body>
  <header>
    <h1>üéûÔ∏è Celeb Slideshow</h1>
    <span class="badge" id="countBadge">Loading‚Ä¶</span>
    <div class="sp"></div>
    <!-- Top play/stop always visible -->
    <button class="btn primary" id="topPlayPause">‚èØÔ∏è Play/Stop</button>
    <!-- Desktop: settings + next-page icons -->
    <button class="iconBtn" id="gearBtn" title="Settings (JSON import/export)">‚öôÔ∏è</button>
    <button class="iconBtn" id="nextTabBtn" title="Next page">‚û°Ô∏è</button>
  </header>

  <nav class="tabs" role="tablist">
    <button class="tab" role="tab" aria-controls="page1" aria-selected="true" id="tab1">Page 1: Slideshow</button>
    <button class="tab" role="tab" aria-controls="page2" aria-selected="false" id="tab2">Page 2: Categories A</button>
    <button class="tab" role="tab" aria-controls="page3" aria-selected="false" id="tab3">Page 3: Categories B</button>
    <button class="tab" role="tab" aria-controls="page4" aria-selected="false" id="tab4">Page 4: Categories C</button>
    <button class="tab" role="tab" aria-controls="page5" aria-selected="false" id="tab5">Page 5: Settings</button>
  </nav>

  <main>
    <section id="page1" class="page active" role="tabpanel" aria-labelledby="tab1">
      <div class="stage" id="stage">
        <div class="imgwrap" id="imgwrap"><div class="hint">Fetching photos‚Ä¶</div></div>
        <!-- Click/tap zones -->
        <div class="hotzone left" id="zoneLeft" title="Previous"></div>
        <div class="hotzone right" id="zoneRight" title="Next"></div>
        <!-- Centered name area below photo -->
        <div class="nameArea">
          <button class="nameToggle" id="nameToggle">Hide name</button>
          <div class="nameBar" id="nameBar">
            <div class="title" id="personName">&nbsp;</div>
            <div class="caption" id="caption"><span class="hint">Tap to show/hide name & credit</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Category pages (16 tiles per page) -->
    <section id="page2" class="page" role="tabpanel" aria-labelledby="tab2">
      <div class="builder">
        <div class="hintRow"><div class="hintToggle" id="hintToggle2" title="Hide/show instructions"></div><div class="hint" id="hint2">Tap to select (blue). Triple‚Äëclick to edit. Apply clears the photo cache and loads only selected categories. Swipe right on mobile to go back.</div></div>
        <div class="grid" id="termGrid1"></div>
        <div class="builderActions">
          <input type="text" id="customTerm1" placeholder="Add a custom term‚Ä¶" />
          <button class="btn ok" id="addTerm1">Add</button>
          <button class="btn primary" id="applyBtn">Apply selection</button>
          <button class="btn danger" id="clearSelBtn">Clear selection</button>
          <span class="hint">Mode:</span>
          <button class="btn" id="modeRandom" aria-pressed="true">Random photos</button>
          <button class="btn" id="modeFixed" aria-pressed="false">Same sequence</button>
        </div>
      </div>
    </section>

    <section id="page3" class="page" role="tabpanel" aria-labelledby="tab3">
      <div class="builder">
        <div class="hintRow"><div class="hintToggle" id="hintToggle3"></div><div class="hint" id="hint3">More categories. Same rules as Page 2.</div></div>
        <div class="grid" id="termGrid2"></div>
        <div class="builderActions">
          <input type="text" id="customTerm2" placeholder="Add a custom term‚Ä¶" />
          <button class="btn ok" id="addTerm2">Add</button>
        </div>
      </div>
    </section>

    <section id="page4" class="page" role="tabpanel" aria-labelledby="tab4">
      <div class="builder">
        <div class="hintRow"><div class="hintToggle" id="hintToggle4"></div><div class="hint" id="hint4">More categories. Same rules as Page 2.</div></div>
        <div class="grid" id="termGrid3"></div>
        <div class="builderActions">
          <input type="text" id="customTerm3" placeholder="Add a custom term‚Ä¶" />
          <button class="btn ok" id="addTerm3">Add</button>
        </div>
      </div>
    </section>

    <section id="page5" class="page" role="tabpanel" aria-labelledby="tab5">
      <div class="builder">
        <div class="hintRow"><div class="hintToggle" id="hintToggle5"></div><div class="hint" id="hint5">Settings: Export your category tiles to JSON or import them later. This lets you save your edits.</div></div>
        <div style="display:grid; gap:10px; max-width:840px">
          <button class="btn primary" id="exportBtn">Export categories ‚Üí JSON</button>
          <textarea id="jsonBox" placeholder='Paste JSON here to import‚Ä¶'></textarea>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn ok" id="importBtn">Import JSON</button>
            <button class="btn warn" id="resetBtn">Reset to defaults</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div>PC keys: Right‚Äëside ‚Üí <strong>Next</strong> (except <kbd>P</kbd> = play/pause). Left‚Äëside ‚Üí <strong>Previous</strong> (except <kbd>S</kbd> = name). <kbd>Space</kbd>/<kbd>P</kbd> = play/pause. Arrows work. While typing/renaming, hotkeys are disabled. Mobile: swipe left on Page 1 to open categories; swipe right on category pages to return.</div>
    <div class="sp"></div>
    <a href="#" id="downloadLink" title="Download current image">Download</a>
  </footer>

  <!-- Floating blue button to toggle quick time buttons -->
  <button class="fab" id="speedFab" title="Speed">‚óè</button>
  <div class="drawer" id="speedDrawer">
    <div class="quickRow">
      <button class="quickBtn" data-s="0.1">0.1s</button>
      <button class="quickBtn" data-s="0.2">0.2s</button>
      <button class="quickBtn" data-s="0.5">0.5s</button>
      <button class="quickBtn" data-s="1">1s</button>
      <button class="quickBtn" data-s="2">2s</button>
      <button class="quickBtn" data-s="5">5s</button>
      <button class="quickBtn" data-s="10">10s</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div class="debug" id="debug"></div>

<script>
(function(){
  // Elements
  const stage = document.getElementById('stage');
  const wrap = document.getElementById('imgwrap');
  const nameBar = document.getElementById('nameBar');
  const nameToggle = document.getElementById('nameToggle');
  const personName = document.getElementById('personName');
  const caption = document.getElementById('caption');
  const countBadge = document.getElementById('countBadge');
  const downloadLink = document.getElementById('downloadLink');
  const toast = document.getElementById('toast');
  const speedFab = document.getElementById('speedFab');
  const speedDrawer = document.getElementById('speedDrawer');
  const debug = document.getElementById('debug');
  const gearBtn = document.getElementById('gearBtn');
  const nextTabBtn = document.getElementById('nextTabBtn');
  const topPlayPause = document.getElementById('topPlayPause');

  // Tabs
  const tabs = [1,2,3,4,5].map(i=>({
    tab: document.getElementById('tab'+i),
    page: document.getElementById('page'+i),
  }));
  function setPage(idx){
    tabs.forEach((t,i)=>{
      const active = (i+1)===idx; t.page.classList.toggle('active', active); t.tab.setAttribute('aria-selected', String(active));
    });
  }
  tabs.forEach((t,i)=> t.tab.addEventListener('click', ()=> setPage(i+1)));
  gearBtn.addEventListener('click', ()=> setPage(5));
  nextTabBtn.addEventListener('click', ()=>{
    const active = tabs.findIndex(t=> t.page.classList.contains('active')) + 1;
    setPage(active%5 + 1);
  });

  // Category grids & controls
  const grids = [
    { grid: document.getElementById('termGrid1'), input: document.getElementById('customTerm1'), add: document.getElementById('addTerm1'), hint: document.getElementById('hint2'), toggle: document.getElementById('hintToggle2') },
    { grid: document.getElementById('termGrid2'), input: document.getElementById('customTerm2'), add: document.getElementById('addTerm2'), hint: document.getElementById('hint3'), toggle: document.getElementById('hintToggle3') },
    { grid: document.getElementById('termGrid3'), input: document.getElementById('customTerm3'), add: document.getElementById('addTerm3'), hint: document.getElementById('hint4'), toggle: document.getElementById('hintToggle4') },
  ];
  const applyBtn = document.getElementById('applyBtn');
  const clearSelBtn = document.getElementById('clearSelBtn');
  const modeRandom = document.getElementById('modeRandom');
  const modeFixed = document.getElementById('modeFixed');
  const jsonBox = document.getElementById('jsonBox');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const resetBtn = document.getElementById('resetBtn');

  // State
  let items = []; // { name, imageUrl, fileTitle, itemUrl }
  let timer = null; let autoplay = true; let currIndex = -1; let lastKeyTime = 0; let fixedOrder = false; let mobileSwipeStart=null;

  // --- Category builders (exact presets) -------------------------------
  function blockHumanWithImage(lines){ return `{ ?person wdt:P31 wd:Q5 ; ${lines.join(' ')} wdt:P18 ?image . }`; }
  function blockFictionalWithImage(lines){ return `{ ?person wdt:P18 ?image . ${lines.join(' ')} }`; }
  const CATEGORY_BLOCKS = {
    'Beatles': () => blockHumanWithImage([ 'wdt:P463 wd:Q1299 ;' ]),
    'Norwegian celebs': () => blockHumanWithImage([ 'wdt:P27 wd:Q20 ;' ]),
    'US celebs': () => blockHumanWithImage([ 'wdt:P27 wd:Q30 ;' ]),
    'Norwegian politicians': () => blockHumanWithImage([ 'wdt:P27 wd:Q20 ;', 'wdt:P106 wd:Q82955 ;' ]),
    'Norwegian ceo': () => blockHumanWithImage([ 'wdt:P27 wd:Q20 ;', 'wdt:P39 wd:Q484876 ;' ]),
    'US ceo': () => blockHumanWithImage([ 'wdt:P27 wd:Q30 ;', 'wdt:P39 wd:Q484876 ;' ]),
    'World ceo': () => blockHumanWithImage([ 'wdt:P39 wd:Q484876 ;' ]),
    'Music producers': () => blockHumanWithImage([ 'wdt:P106 wd:Q183945 ;' ]),
    "Models of the 50's": () => `{ ?person wdt:P31 wd:Q5 ; wdt:P106 wd:Q4610556 ; wdt:P18 ?image . OPTIONAL { ?person wdt:P2031 ?start . } OPTIONAL { ?person wdt:P2032 ?end . } FILTER( (BOUND(?start) && year(?start) <= 1959) || (BOUND(?end) && year(?end) >= 1950) || (!BOUND(?start) && !BOUND(?end)) ) }`,
    "Models of the 80's": () => `{ ?person wdt:P31 wd:Q5 ; wdt:P106 wd:Q4610556 ; wdt:P18 ?image . OPTIONAL { ?person wdt:P2031 ?start . } OPTIONAL { ?person wdt:P2032 ?end . } FILTER( (BOUND(?start) && year(?start) <= 1989) || (BOUND(?end) && year(?end) >= 1980) || (!BOUND(?start) && !BOUND(?end)) ) }`,
    'famous movie characters': () => blockFictionalWithImage([ ' ?person wdt:P31 wd:Q15773347 . ' ]),
    'famous cartoon characters': () => blockFictionalWithImage([ ' { ?person wdt:P31 wd:Q15711870 . } UNION { ?person wdt:P31 wd:Q373494 . } ' ]),
  };

  // Heuristic fallback (country/role words)
  const countryMap = { 'norwegian':'Q20','norway':'Q20','swedish':'Q34','sweden':'Q34','danish':'Q35','denmark':'Q35','finnish':'Q33','finland':'Q33','icelandic':'Q189','iceland':'Q189','british':'Q145','uk':'Q145','english':'Q21','scottish':'Q22','irish':'Q27','french':'Q142','german':'Q183','spanish':'Q29','italian':'Q38','american':'Q30','us':'Q30','canadian':'Q16','indian':'Q668','japanese':'Q17','korean':'Q884','brazilian':'Q155' };
  const roleMap = { 'actor':'Q33999','actors':'Q33999','actress':'Q33999','film actors':'Q33999','movie stars':'Q33999','musician':'Q639669','musicians':'Q639669','singer':'Q177220','singers':'Q177220','record producer':'Q183945','producer':'Q183945','comedian':'Q245068','comedians':'Q245068','writer':'Q36180','writers':'Q36180','politician':'Q82955','politicians':'Q82955','footballer':'Q937857','footballers':'Q937857','director':'Q2526255','film directors':'Q2526255','tv presenters':'Q947873','youtubers':'Q1931868','influencers':'Q20074590','model':'Q4610556','models':'Q4610556' };

  function buildSPARQLFromTerms(terms){
    const blocks = [];
    terms.forEach(t => {
      const label = (t || '').trim();
      const fixed = CATEGORY_BLOCKS[label] || CATEGORY_BLOCKS[label.replace(/celbs/i,'celebs')];
      if (fixed) { blocks.push(fixed()); return; }
      const key = label.toLowerCase();
      let countryQ=null, roleQ=null; Object.keys(countryMap).forEach(k=>{ if(key.includes(k)) countryQ = countryQ || countryMap[k]; }); Object.keys(roleMap).forEach(k=>{ if(key.includes(k)) roleQ = roleQ || roleMap[k]; });
      const parts = ['?person wdt:P31 wd:Q5 ;'];
      if(countryQ) parts.push(` wdt:P27 wd:${countryQ} ;`);
      if(roleQ) parts.push(` wdt:P106 wd:${roleQ} ;`);
      parts.push(' wdt:P18 ?image .');
      blocks.push(`{ ${parts.join('')} }`);
    });
    const union = blocks.join('\nUNION\n');
    return `SELECT ?person ?personLabel ?image WHERE {\n${union}\nSERVICE wikibase:label { bd:serviceParam wikibase:language "nb,nn,no,en". }\n}\nLIMIT 1000`;
  }

  async function sparqlQuery(query){
    const endpoint = 'https://query.wikidata.org/sparql';
    const body = new URLSearchParams(); body.set('query', query);
    const res = await fetch(endpoint, { method:'POST', mode:'cors', headers:{ 'Accept':'application/sparql-results+json', 'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8' }, body });
    if(!res.ok) throw new Error('WDQS HTTP '+res.status);
    return await res.json();
  }

  async function fetchWDFromTerms(terms){
    const sparql = buildSPARQLFromTerms(terms);
    const data = await sparqlQuery(sparql);
    const rows = data.results.bindings || [];
    return rows.map(r=>{
      const name = r.personLabel?.value || 'Unknown';
      const imageField = r.image?.value || '';
      let imageUrl = imageField;
      if (!imageUrl.includes('Special:FilePath')) {
        let fn = imageUrl;
        if (fn.startsWith('http')) { try { const u = new URL(fn); const last = decodeURIComponent(u.pathname.split('/').pop()); fn = last.startsWith('File:') ? last : 'File:'+last; } catch {} }
        if (!fn.startsWith('File:')) fn = 'File:' + fn.replace(/^.*File:/,'');
        imageUrl = 'https://commons.wikimedia.org/wiki/Special:FilePath/' + encodeURIComponent(fn.replace(/^File:/,'')) + '?width=1600';
      } else { if (!/\?width=/.test(imageUrl)) imageUrl += (imageUrl.includes('?')?'&':'?')+'width=1600'; }
      let fileTitle = 'File:'; if (imageUrl.includes('Special:FilePath/')) fileTitle += decodeURIComponent(imageUrl.split('Special:FilePath/')[1].split('?')[0]);
      const itemUrl = r.person?.value || '#';
      return { name, imageUrl, fileTitle, itemUrl };
    });
  }

  async function fetchAttribution(fileTitle){
    try{
      const url = 'https://commons.wikimedia.org/w/api.php?action=query&format=json&origin=*&prop=imageinfo&iiprop=extmetadata|url&titles=' + encodeURIComponent(fileTitle);
      const res = await fetch(url); const data = await res.json();
      const page = data?.query?.pages ? Object.values(data.query.pages)[0] : null;
      const info = page?.imageinfo?.[0]; const meta = info?.extmetadata || {};
      const artist = meta.Artist?.value || ''; const credit = meta.Credit?.value || ''; const license = meta.LicenseShortName?.value || '';
      const filePageUrl = page?.fullurl || ('https://commons.wikimedia.org/wiki/' + encodeURIComponent(fileTitle));
      return { artist, credit, license, filePageUrl };
    }catch(e){ return { artist:'', credit:'', license:'', filePageUrl: 'https://commons.wikimedia.org/wiki/' + encodeURIComponent(fileTitle) }; }
  }

  function clearImage(){ wrap.innerHTML = '<div class="hint">Loading‚Ä¶</div>'; }

  async function showIndex(i){ if(!items.length) return; currIndex = (i + items.length) % items.length; const it = items[currIndex]; clearImage(); const img = new Image(); img.className='photo'; img.decoding='async'; img.onload = async ()=>{ wrap.innerHTML=''; wrap.appendChild(img); nameBar.classList.add('collapsed'); personName.innerHTML = `<a href="${it.itemUrl}" target="_blank" rel="noopener" style="color:var(--fg); text-decoration:none">${it.name}</a>`; const { artist, credit, license, filePageUrl } = await fetchAttribution(it.fileTitle); const creditText = artist || credit || ''; caption.innerHTML = `${creditText ? creditText + ' ‚Ä¢ ' : ''}<a href="${filePageUrl}" target="_blank" rel="noopener">${it.fileTitle}</a>${license? ' ‚Ä¢ License: '+license : ''}`; downloadLink.href = it.imageUrl; downloadLink.download = it.fileTitle.replace(/^File:/,''); setTimeout(()=>{ nameBar.classList.remove('collapsed'); updateNameToggle(); }, 500); }; img.onerror = ()=>{ toast.textContent='Skipped an image that failed to load'; toast.style.display='block'; setTimeout(()=> toast.style.display='none', 1200); next(); }; img.src = it.imageUrl; }
  function next(){ showIndex((currIndex + 1) % items.length); }
  function prev(){ showIndex((currIndex - 1 + items.length) % items.length); }
  function clampSeconds(){ let v = 2; const s=document.getElementById('secs'); const r=document.getElementById('speed'); if(s){ v=Number(s.value)||2; if(v<0.1) v=0.1; if(v>10) v=10; s.value=v; } if(r) r.value=v; return v; }
  function startAutoplay(){ if(timer) clearInterval(timer); const s = clampSeconds(); timer = setInterval(next, s * 1000); autoplay = true; topPlayPause.textContent='‚èπ Stop'; }
  function stopAutoplay(){ if(timer) clearInterval(timer); timer=null; autoplay=false; topPlayPause.textContent='‚ñ∂Ô∏è Play'; }
  function setMode(isFixed){ fixedOrder = !!isFixed; modeRandom?.setAttribute('aria-pressed', String(!fixedOrder)); modeFixed?.setAttribute('aria-pressed', String(fixedOrder)); }

  async function applySelection(){ items = []; currIndex = -1; wrap.innerHTML = '<div class="hint">Applying selection‚Ä¶</div>'; countBadge.textContent = 'Fetching‚Ä¶'; const chosen = collectSelectedTerms(); if(!chosen.length){ toast.textContent='Select one or more categories first.'; toast.style.display='block'; setTimeout(()=> toast.style.display='none', 1200); return; } try{ let data = await fetchWDFromTerms(chosen); if(!fixedOrder) data = data.sort(()=>Math.random()-0.5); items = data; countBadge.textContent = `${items.length} photos`; if(!items.length){ wrap.innerHTML = '<div class="hint">No results. Try different categories.</div>'; return; } showIndex(0); startAutoplay(); debug.textContent = 'Loaded '+items.length+' photos.'; }catch(e){ console.error(e); wrap.innerHTML='<div class="hint">Error fetching photos.</div>'; countBadge.textContent='0'; debug.textContent = e.message; } }

  function collectSelectedTerms(){ const out=[]; grids.forEach(g=> out.push(...Array.from(g.grid.querySelectorAll('.termBtn.selected')).map(b=> b.dataset.term||b.textContent.trim()))); return out.filter(Boolean); }

  // Keyboard mapping (disable while typing in inputs)
  function isTypingTarget(t){ if(!t) return false; const tag = (t.tagName||'').toLowerCase(); return tag==='input' || tag==='textarea' || t.isContentEditable; }
  function updateNameToggle(){ nameToggle.textContent = nameBar.classList.contains('collapsed') ? 'Show name' : 'Hide name'; }
  function toggleName(){ nameBar.classList.toggle('collapsed'); updateNameToggle(); }
  document.addEventListener('keydown', (e)=>{ if(isTypingTarget(e.target)) return; const now=Date.now(); if(now - lastKeyTime < 120) return; lastKeyTime = now; const key = (e.key || '').toLowerCase(); if (e.code === 'Space' || key === 'p') { e.preventDefault(); if(autoplay) stopAutoplay(); else startAutoplay(); return; } if (key === 's') { e.preventDefault(); toggleName(); return; } if (key === 'arrowleft') { e.preventDefault(); stopAutoplay(); prev(); return; } if (key === 'arrowright') { e.preventDefault(); stopAutoplay(); next(); return; } const leftSet = new Set(['`','1','2','3','4','5','q','w','e','r','t','a','d','f','g','z','x','c','v','b']); const rightSet = new Set(['6','7','8','9','0','-','=', 'y','u','i','o','p','[',']','\\', 'h','j','k','l',';','\'', 'n','m',',','.','/']); if (e.location === 3) { stopAutoplay(); next(); return; } if (rightSet.has(key)) { stopAutoplay(); next(); return; } if (leftSet.has(key)) { stopAutoplay(); prev(); return; } });

  // Swipe: page switching + photo nav
  function onTouchStart(e){ const t=e.changedTouches[0]; mobileSwipeStart = {x:t.clientX, y:t.clientY}; }
  function onTouchEnd(e){ if(!mobileSwipeStart) return; const t=e.changedTouches[0]; const dx=t.clientX - mobileSwipeStart.x; const dy=t.clientY - mobileSwipeStart.y; const adx=Math.abs(dx), ady=Math.abs(dy); if(adx>40 && ady<60){ if(tabs[0].page.classList.contains('active')){ if(dx<0 && window.innerWidth<768){ setPage(2); return; } if(dx<0){ stopAutoplay(); next(); return; } if(dx>0){ stopAutoplay(); prev(); return; } } else { // any category page
      if(dx>0 && window.innerWidth<768){ setPage(1); return; }
    } } }
  document.addEventListener('touchstart', onTouchStart, {passive:true});
  document.addEventListener('touchend', onTouchEnd, {passive:true});

  // Click zones (left 1/3 prev, right 2/3 next; middle included in next)
  document.getElementById('zoneLeft').addEventListener('click', ()=>{ stopAutoplay(); prev(); });
  document.getElementById('zoneRight').addEventListener('click', ()=>{ stopAutoplay(); next(); });

  // Top play/stop
  topPlayPause.addEventListener('click', ()=>{ if(autoplay) stopAutoplay(); else startAutoplay(); });

  // Speed quick drawer
  speedFab.addEventListener('click', ()=>{ speedDrawer.classList.toggle('open'); });
  speedDrawer.querySelectorAll('.quickBtn').forEach(btn=>{ btn.addEventListener('click', ()=>{ const v = Number(btn.dataset.s); const s=document.getElementById('secs'); const r=document.getElementById('speed'); if(s) s.value=v; if(r) r.value=v; if(autoplay) startAutoplay(); }); });

  // Builder UI helpers
  function makeTermButton(label, gridEl){ const btn = document.createElement('button'); btn.type='button'; btn.className='termBtn'; btn.textContent=label; btn.dataset.term = label; btn.dataset.clicks='0'; btn.addEventListener('click', ()=>{ const c=(+btn.dataset.clicks||0)+1; btn.dataset.clicks = String(c); if(c>=3){ btn.dataset.clicks='0'; btn.classList.add('editing'); const prev = btn.dataset.term; const input = document.createElement('input'); input.type='text'; input.value=prev; input.style.width='100%'; input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const v = input.value.trim()||prev; btn.dataset.term = v; btn.textContent=v; btn.classList.remove('editing'); } }); input.addEventListener('blur', ()=>{ const v = input.value.trim()||prev; btn.dataset.term = v; btn.textContent=v; btn.classList.remove('editing'); }); btn.innerHTML=''; btn.appendChild(input); input.focus(); input.select(); return; } btn.classList.toggle('selected'); setTimeout(()=>{ btn.dataset.clicks='0'; }, 400); }); gridEl.appendChild(btn); return btn; }

  function gatherAllTiles(){ const tiles=[]; grids.forEach((g,gi)=>{ g.grid.querySelectorAll('.termBtn').forEach((b,idx)=>{ tiles.push({ label:b.dataset.term||b.textContent.trim(), selected:b.classList.contains('selected'), page:gi+2, index:idx }); }); }); return tiles; }
  function renderFromTiles(tiles){ grids.forEach(g=> g.grid.innerHTML=''); tiles.forEach((t,i)=>{ const gi = Math.min(Math.floor(i/16), grids.length-1); const grid = grids[gi].grid; const b = makeTermButton(t.label, grid); if(t.selected) b.classList.add('selected'); }); ensureMinTiles(); attachAddHandlers(); }
  function ensureMinTiles(){ const total = grids.reduce((n,g)=> n + g.grid.querySelectorAll('.termBtn').length, 0); for(let i=total;i<48;i++){ const gi=Math.min(Math.floor(i/16), grids.length-1); makeTermButton('Custom term', grids[gi].grid); } }

  function exportJSON(){ const tiles = gatherAllTiles().map(t=>({label:t.label, selected:t.selected})); return JSON.stringify({ version:1, tiles }, null, 2); }
  function importJSON(str){ const obj = JSON.parse(str); if(!obj || !Array.isArray(obj.tiles)) throw new Error('Invalid JSON'); renderFromTiles(obj.tiles.map(x=>({label:x.label, selected:!!x.selected}))); }

  function attachAddHandlers(){ grids.forEach(g=>{ if(g.add){ g.add.onclick = ()=>{ const t=(g.input.value||'').trim(); if(!t) return; const count = g.grid.querySelectorAll('.termBtn').length; if(count>=16){ // push to next grid if full
            const nextIndex = grids.indexOf(g)+1; const ng = grids[Math.min(nextIndex, grids.length-1)]; makeTermButton(t, ng.grid); } else { makeTermButton(t, g.grid); } g.input.value=''; }; } if(g.toggle && g.hint){ g.toggle.onclick = ()=> g.hint.style.display = (g.hint.style.display==='none'?'':'none'); } }); }

  function populateDefaults(){ grids.forEach(g=> g.grid.innerHTML=''); const presets = [ 'Beatles', 'Norwegian celebs', 'US celebs', 'Norwegian politicians', 'Norwegian ceo', 'US ceo', 'World ceo', 'Music producers', "Models of the 50's", "Models of the 80's", 'famous movie characters', 'famous cartoon characters', 'Norwegian actors','Norwegian musicians','Norwegian comedians','Norwegian writers', 'UK celebrity','British actors','German footballers','50s movie stars', 'Danish actors','Swedish politicians','Icelandic singers','Finnish musicians', 'Italian actors','Spanish footballers','French actors','Canadian singers', 'Indian actors','Japanese actors','Korean pop singers','Brazilian footballers', 'American film directors','Irish musicians','British comedians','TV presenters' ]; presets.forEach((p,i)=>{ const gi=Math.min(Math.floor(i/16), grids.length-1); makeTermButton(p, grids[gi].grid); }); ensureMinTiles(); attachAddHandlers(); }

  // Selection controls
  clearSelBtn.addEventListener('click', ()=>{ grids.forEach(g=> g.grid.querySelectorAll('.termBtn.selected').forEach(b=> b.classList.remove('selected'))); items=[]; currIndex=-1; wrap.innerHTML = '<div class="hint">Selection cleared.</div>'; countBadge.textContent='0'; stopAutoplay(); });
  applyBtn.addEventListener('click', ()=>{ setPage(1); applySelection(); });
  modeRandom.addEventListener('click', ()=>{ setMode(false); toast.textContent='Mode: Random photos'; toast.style.display='block'; setTimeout(()=> toast.style.display='none', 1000); if(items.length){ items = items.sort(()=>Math.random()-0.5); currIndex = -1; showIndex(0); } });
  modeFixed.addEventListener('click', ()=>{ setMode(true); toast.textContent='Mode: Same sequence'; toast.style.display='block'; setTimeout(()=> toast.style.display='none', 1000); });

  // JSON import / export
  exportBtn.addEventListener('click', ()=>{ jsonBox.value = exportJSON(); toast.textContent='Exported current tiles to JSON'; toast.style.display='block'; setTimeout(()=> toast.style.display='none', 1200); });
  importBtn.addEventListener('click', ()=>{ try{ importJSON(jsonBox.value); toast.textContent='Imported categories'; toast.style.display='block'; setTimeout(()=> toast.style.display='none', 1200); }catch(e){ toast.textContent='Import failed: '+e.message; toast.style.display='block'; setTimeout(()=> toast.style.display='none', 1800); } });
  resetBtn.addEventListener('click', ()=>{ populateDefaults(); jsonBox.value=''; toast.textContent='Reset to defaults'; toast.style.display='block'; setTimeout(()=> toast.style.display='none', 1000); });

  // Init
  populateDefaults();
  // default select a few
  grids[0].grid.querySelectorAll('.termBtn').forEach(b=>{ if(['Norwegian celebs','Norwegian actors','Norwegian musicians'].includes(b.dataset.term)) b.classList.add('selected'); });
  applySelection();
})();
</script>
</body>
</html>
