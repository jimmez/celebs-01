<!-- v19 -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Celeb Slideshow ‚Äî Random Photo Fetcher (v19)</title>
<meta name="description" content="v19: photos always centered, no blue FAB, timing in Settings, categories auto-apply (random only), Clear on pages 2‚Äì4, seamless swaps." />
<style>
  :root { --bg:#0b0f14; --rail:#0d1420; --fg:#e5eef7; --muted:#93a3b8; --accent:#60a5fa; --ok:#34d399; --danger:#f87171; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
    display:grid; grid-template-rows:auto auto 1fr auto; min-height:100vh;
  }
  header{display:flex; gap:10px; align-items:center; padding:10px 12px; position:sticky; top:0; z-index:50; background:rgba(2,6,23,.6); backdrop-filter:blur(8px) saturate(1.1); border-bottom:1px solid rgba(255,255,255,.06)}
  h1{font-size:16px; margin:0}
  .sp{flex:1}
  .iconBtn{width:36px; height:36px; display:grid; place-items:center; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); cursor:pointer}
  .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); color:var(--fg); cursor:pointer; font-weight:700}
  .btn.primary{border-color:rgba(96,165,250,.6); background:rgba(96,165,250,.15)}
  .btn.ok{border-color:rgba(52,211,153,.6); background:rgba(52,211,153,.15)}
  .btn.danger{border-color:rgba(248,113,113,.7); background:rgba(248,113,113,.18)}
  .btn.playing{border-color:rgba(52,211,153,.9); background:rgba(52,211,153,.28)}
  .badge{font-size:12px; padding:4px 8px; border:1px solid rgba(255,255,255,.12); border-radius:999px}

  /* Tabs */
  .tabs{display:flex; gap:8px; padding:8px 12px; border-bottom:1px solid rgba(255,255,255,.06); background:rgba(2,6,23,.35); overflow:auto; position:sticky; top:56px; z-index:49}
  .tab{padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.1); cursor:pointer; white-space:nowrap}
  .tab[aria-selected="true"]{background:rgba(96,165,250,.15); border-color:rgba(96,165,250,.6)}

  main{min-height:0}
  .page{display:none; height:100%; overflow:auto}
  .page.active{display:block}

  /* Left rail */
  .leftRail{
    position:fixed; left:0; top:0; bottom:0; width:74px; background:linear-gradient(180deg,var(--rail),rgba(8,12,20,.9));
    border-right:1px solid rgba(255,255,255,.06); z-index:65; display:grid; grid-template-rows:1fr auto auto 1fr; gap:10px; place-items:center; padding-bottom:12px;
  }
  .leftRail::before{content:''; position:absolute; top:0; bottom:0; left:0; width:6px; background:rgba(255,255,255,.06)}
  .leftRail.playing::before{background:var(--ok)}
  .railBtn{width:64px; min-height:44px; display:grid; place-items:center; padding:8px; text-align:center}
  .playButtonBig{width:64px; height:64px; border-radius:16px; font-size:20px; display:grid; place-items:center}
  #showThisName{ height:132px; } /* 3√ó taller */

  /* Stage: always centered */
  .stage{
    position:relative; margin-left:74px; /* reserve rail space */
    display:flex; align-items:center; justify-content:center;
    height:calc(100vh - (56px + 48px + 52px)); /* header + tabs ~ + footer approx; js updates exact */
    overflow:hidden;
  }
  @media (max-width:768px){ .stage{ margin-left:64px } }

  .imgwrap{ position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
  img.photo{
    max-width:85%; max-height:85%;
    object-fit:contain; border-radius:18px; box-shadow:0 12px 36px rgba(0,0,0,.6);
    opacity:0; transition:opacity .18s ease;
  }
  img.photo.show{opacity:1}

  /* Tap zones */
  .hotzone{position:absolute; top:0; bottom:0; z-index:10}
  .hotzone.left{left:74px; width:calc(33.333% - 74px)}
  .hotzone.right{right:0; width:66.667%}
  @media (max-width:768px){ .hotzone.left{left:64px; width:calc(33.333% - 64px)} }

  /* Name overlay ~30% bottom of photo area */
  .nameArea{position:absolute; left:74px; right:0; bottom:0; height:30%; display:grid; place-items:center; padding:8px; z-index:40}
  @media (max-width:768px){ .nameArea{ left:64px } }
  .nameBackdrop{position:absolute; inset:0; background:linear-gradient(180deg, rgba(2,6,23,0) 0%, rgba(2,6,23,.75) 35%, rgba(2,6,23,.92) 100%)}
  .nameLayer{position:relative; width:min(92%, 900px); display:grid; gap:10px; justify-items:center}
  .nameBar{width:100%; background:transparent; border:none; padding:0; text-align:center}
  .nameBar.collapsed{display:none}
  .title{font-size:24px; font-weight:900; text-shadow:0 2px 12px rgba(0,0,0,.85)}

  /* Category pages */
  .builder{padding:12px}
  .hint{font-size:13px; color:var(--muted); margin-bottom:8px}
  .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(160px, 1fr)); gap:10px}
  .termBtn{padding:12px 14px; border-radius:12px; background:#111827; border:1px solid rgba(255,255,255,.22); cursor:pointer; text-align:left; user-select:none; color:#fff}
  .termBtn.selected{outline:2px solid var(--accent); background:#1f2937}

  .builderActions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; align-items:center}
  .builderActions .sp{flex:1}

  footer{padding:10px 12px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; color:var(--muted); border-top:1px solid rgba(255,255,255,.06)}
  footer a{color:var(--ok); text-decoration:none}

  .toast{position:fixed; right:16px; bottom:16px; background:rgba(2,6,23,.85); color:var(--fg); border:1px solid rgba(255,255,255,.09); padding:10px 12px; border-radius:12px; font-size:13px; display:none; z-index:200}

  /* Settings steppers */
  .stepper{display:inline-flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid rgba(255,255,255,.14); border-radius:10px; background:rgba(255,255,255,.06)}
  .quickBtn{padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); color:#e5eef7; cursor:pointer; font-weight:700}
  .stepVal{min-width:40px; text-align:center; font-weight:800}
</style>
</head>
<body>
<header>
  <h1>üéûÔ∏è Celeb Slideshow</h1>
  <span class="badge" id="countBadge">‚Äî</span>
  <div class="sp"></div>
  <button class="iconBtn" id="gearBtn" title="Settings (JSON & timing)">‚öôÔ∏è</button>
  <button class="btn ok" id="openLinkHeader" title="Open source page">Link</button>
  <button class="iconBtn" id="nextTabBtn" title="Next page">‚û°Ô∏è</button>
</header>

<nav class="tabs" role="tablist" id="tabsRow">
  <button class="tab" role="tab" aria-controls="page1" aria-selected="true"  id="tab1">Page 1: Slideshow</button>
  <button class="tab" role="tab" aria-controls="page2" aria-selected="false" id="tab2">Page 2: Categories A</button>
  <button class="tab" role="tab" aria-controls="page3" aria-selected="false" id="tab3">Page 3: Categories B</button>
  <button class="tab" role="tab" aria-controls="page4" aria-selected="false" id="tab4">Page 4: Categories C</button>
  <button class="tab" role="tab" aria-controls="page5" aria-selected="false" id="tab5">Page 5: Settings</button>
</nav>

<main id="mainArea">
  <!-- Page 1 -->
  <section id="page1" class="page active" role="tabpanel" aria-labelledby="tab1">
    <div class="leftRail" id="leftRail">
      <button class="btn railBtn" id="hideAllNames" title="Hide/Show names">Hide</button>
      <button class="btn primary playButtonBig" id="cornerPlayStop" title="Play / Stop">‚èØÔ∏è</button>
      <button class="btn railBtn" id="showThisName" title="Show this photo‚Äôs name">Show</button>
    </div>

    <div class="stage" id="stage">
      <div class="imgwrap" id="imgwrap"></div>
      <div class="hotzone left"  id="zoneLeft"  title="Previous"></div>
      <div class="hotzone right" id="zoneRight" title="Next"></div>

      <div class="nameArea">
        <div class="nameBackdrop"></div>
        <div class="nameLayer">
          <div class="nameBar" id="nameBar"><div class="title" id="entityName">&nbsp;</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Page 2 -->
  <section id="page2" class="page" role="tabpanel" aria-labelledby="tab2">
    <div class="builder">
      <div class="hint">Tap categories to include them. Selection applies automatically (random order). Use ‚ÄúClear selection‚Äù.</div>
      <div class="grid" id="termGrid1"></div>
      <div class="builderActions">
        <input type="text" id="customTerm1" placeholder="Add a custom term‚Ä¶ (e.g., cars of 2010)" />
        <button class="btn ok" id="addTerm1">Add</button>
        <div class="sp"></div>
        <button class="btn danger" id="clearSelBtn">Clear selection</button>
      </div>
    </div>
  </section>

  <!-- Page 3 -->
  <section id="page3" class="page" role="tabpanel" aria-labelledby="tab3">
    <div class="builder">
      <div class="grid" id="termGrid2"></div>
      <div class="builderActions">
        <input type="text" id="customTerm2" placeholder="Add a custom term‚Ä¶" />
        <button class="btn ok" id="addTerm2">Add</button>
        <div class="sp"></div>
        <button class="btn danger" id="clearSelBtn2">Clear selection</button>
      </div>
    </div>
  </section>

  <!-- Page 4 -->
  <section id="page4" class="page" role="tabpanel" aria-labelledby="tab4">
    <div class="builder">
      <div class="grid" id="termGrid3"></div>
      <div class="builderActions">
        <input type="text" id="customTerm3" placeholder="Add a custom term‚Ä¶" />
        <button class="btn ok" id="addTerm3">Add</button>
        <div class="sp"></div>
        <button class="btn danger" id="clearSelBtn3">Clear selection</button>
      </div>
    </div>
  </section>

  <!-- Page 5: Settings (timing + JSON) -->
  <section id="page5" class="page" role="tabpanel" aria-labelledby="tab5">
    <div class="builder" style="max-width:720px">
      <h3>Timing</h3>
      <div class="hint">Slide speed and Name reveal delay (seconds ¬±1s, steps of 0.2s).</div>
      <div class="builderActions">
        <span>Slide speed</span>
        <div class="stepper" id="fineRow">
          <button class="quickBtn" data-delta="-1">‚àí1s</button>
          <span class="stepVal" id="fineSec">2.0</span>
          <button class="quickBtn" data-delta="1">Ôºã1s</button>
        </div>
        <div class="stepper">
          <button class="quickBtn" data-delta="-0.2" data-type="ms">‚àí0.2s</button>
          <span class="stepVal" id="fineMs">0.0</span>
          <button class="quickBtn" data-delta="0.2" data-type="ms">Ôºã0.2s</button>
        </div>
        <strong id="fineTotal">2.0s</strong>
      </div>

      <div class="builderActions">
        <span>Name reveal</span>
        <div class="stepper" id="nameFineRow">
          <button class="quickBtn" data-delta="-1">‚àí1s</button>
          <span class="stepVal" id="nameSec">0.5</span>
          <button class="quickBtn" data-delta="1">Ôºã1s</button>
        </div>
        <div class="stepper">
          <button class="quickBtn" data-delta="-0.2" data-type="ms">‚àí0.2s</button>
          <span class="stepVal" id="nameMs">0.0</span>
          <button class="quickBtn" data-delta="0.2" data-type="ms">Ôºã0.2s</button>
        </div>
        <strong id="nameTotal">0.5s</strong>
      </div>

      <h3>Categories JSON</h3>
      <div class="builderActions">
        <button class="btn primary" id="exportBtn">Export ‚Üí JSON</button>
        <button class="btn ok" id="importBtn">Import JSON</button>
        <button class="btn" id="resetBtn">Reset defaults</button>
      </div>
      <textarea id="jsonBox" placeholder='Paste JSON here to import‚Ä¶' style="width:100%; min-height:180px"></textarea>
    </div>
  </section>
</main>

<footer>
  <div>PC keys: right side ‚Üí Next (except <kbd>P</kbd>=play/pause). Left side ‚Üí Previous (except <kbd>S</kbd>=name). <kbd>Space</kbd>/<kbd>P</kbd>=play/pause. Mobile: swipe left/right to switch pages.</div>
  <div class="sp"></div>
  <a href="#" id="downloadLink" title="Download current image">Download</a>
</footer>

<div class="toast" id="toast"></div>

<script>
(function(){
  // ---------- Layout helpers: keep stage perfectly centered
  const header = document.querySelector('header');
  const tabsRow = document.getElementById('tabsRow');
  const footer = document.querySelector('footer');
  const stage  = document.getElementById('stage');
  function setStageHeight(){
    const h = window.innerHeight;
    const used = header.offsetHeight + tabsRow.offsetHeight + footer.offsetHeight;
    stage.style.height = Math.max(280, h - used) + 'px';
  }
  addEventListener('resize', setStageHeight);
  addEventListener('orientationchange', setStageHeight);
  setStageHeight();

  // ---------- Tabs
  const tabs = [1,2,3,4,5].map(i=>({ tab: document.getElementById('tab'+i), page: document.getElementById('page'+i) }));
  function setPage(idx){
    tabs.forEach((t,i)=>{ const on=(i+1)===idx; t.page.classList.toggle('active', on); t.tab.setAttribute('aria-selected', String(on)); });
    setStageHeight();
  }
  tabs.forEach((t,i)=> t.tab.addEventListener('click', ()=> setPage(i+1)));
  document.getElementById('gearBtn').addEventListener('click', ()=> setPage(5));
  document.getElementById('nextTabBtn').addEventListener('click', ()=>{
    const active = tabs.findIndex(t=> t.page.classList.contains('active')) + 1;
    setPage(active%5 + 1);
  });

  // ---------- Elements & state
  const leftRail = document.getElementById('leftRail');
  const cornerPlayStop = document.getElementById('cornerPlayStop');
  const hideAllNamesBtn = document.getElementById('hideAllNames');
  const showThisNameBtn = document.getElementById('showThisName');
  const imgwrap = document.getElementById('imgwrap');
  const nameBar = document.getElementById('nameBar');
  const entityName = document.getElementById('entityName');
  const openLinkHeader = document.getElementById('openLinkHeader');
  const countBadge = document.getElementById('countBadge');
  const downloadLink = document.getElementById('downloadLink');
  const toast = document.getElementById('toast');

  let autoplay=false, timer=null;
  let items=[], currIndex=-1, currentImg=null, currentLink='#';
  let globalHideNames=true, perSlideReveal=false;
  window.__slideSeconds = 2.0;
  let nameDelay = 500;

  // ---------- Timing controls (Settings page)
  function roundStep(v){ return Number((Math.round(v/0.2)*0.2).toFixed(1)); }
  function updateSpeedDisplay(){
    const s = window.__slideSeconds;
    const sec = Math.floor(s);
    const frac = roundStep(s-sec);
    document.getElementById('fineSec').textContent = (sec+frac).toFixed(1); // show combined nicely
    document.getElementById('fineMs').textContent = frac.toFixed(1);
    document.getElementById('fineTotal').textContent = (sec+frac).toFixed(1)+'s';
  }
  function setSlide(s){
    s = Math.max(0, Math.min(10, s));
    window.__slideSeconds = roundStep(s);
    updateSpeedDisplay();
    if(autoplay) startAutoplay();
  }
  updateSpeedDisplay();
  document.querySelectorAll('#fineRow .quickBtn, #fineRow + .stepper .quickBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const delta = Number(btn.dataset.delta);
      setSlide((window.__slideSeconds||0) + delta);
    });
  });

  function updateNameDisplay(){
    const s = roundStep(nameDelay/1000);
    const sec = Math.floor(s);
    const frac = roundStep(s-sec);
    document.getElementById('nameSec').textContent = (sec+frac).toFixed(1);
    document.getElementById('nameMs').textContent = frac.toFixed(1);
    document.getElementById('nameTotal').textContent = (sec+frac).toFixed(1)+'s';
  }
  function setNameDelaySeconds(s){
    s = Math.max(0, Math.min(10, s));
    nameDelay = Math.round(roundStep(s)*1000);
    updateNameDisplay();
  }
  updateNameDisplay();
  document.querySelectorAll('#nameFineRow .quickBtn, #nameFineRow + .stepper .quickBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const delta = Number(btn.dataset.delta);
      setNameDelaySeconds((nameDelay/1000) + delta);
    });
  });

  // ---------- Keyboard
  let lastKeyTime=0;
  function isTyping(t){ return t && (t.tagName==='INPUT' || t.tagName==='TEXTAREA' || t.isContentEditable); }
  document.addEventListener('keydown', e=>{
    if(isTyping(e.target)) return;
    const now=Date.now(); if(now-lastKeyTime<120) return; lastKeyTime=now;
    const key=(e.key||'').toLowerCase();
    if (e.code==='Space'||key==='p'){ e.preventDefault(); autoplay? stopAutoplay() : startAutoplay(); return; }
    if (key==='s'){ e.preventDefault(); toggleGlobalName(); return; }
    if (key==='arrowleft'){ e.preventDefault(); stopAutoplay(); prev(); return; }
    if (key==='arrowright'){ e.preventDefault(); stopAutoplay(); next(); return; }
  });

  // ---------- Image pipeline (seamless + fallback)
  function swapIn(img){
    const prev = currentImg;
    currentImg = img; currentImg.classList.add('photo','show');
    imgwrap.appendChild(currentImg);
    if(prev){
      prev.addEventListener('transitionend', ()=>{ try{ imgwrap.removeChild(prev); }catch{} }, {once:true});
      prev.classList.remove('show');
    }
  }

  function loadWithFallback(url, fileName){
    return new Promise((resolve,reject)=>{
      const img = new Image(); img.decoding='async'; img.referrerPolicy='no-referrer';
      img.onload = ()=> resolve(img);
      img.onerror = ()=>{
        const alt = 'https://commons.wikimedia.org/w/thumb.php?width=1600&f=' + encodeURIComponent((fileName||'').replace(/^File:/,''));
        const img2 = new Image(); img2.decoding='async'; img2.referrerPolicy='no-referrer';
        img2.onload = ()=> resolve(img2);
        img2.onerror = ()=> reject(new Error('both loaders failed'));
        img2.src = alt;
      };
      img.src = url;
    });
  }

  async function showIndex(i){
    if(!items.length) return;
    currIndex = (i + items.length) % items.length;
    const it = items[currIndex];
    try{
      const fileName = it.fileTitle || 'File:';
      const img = await loadWithFallback(it.imageUrl, fileName);
      swapIn(img);
      entityName.textContent = it.name || '‚Äî';
      nameBar.classList.add('collapsed');
      setTimeout(()=>{
        const shouldShow = (!globalHideNames) || perSlideReveal;
        if(shouldShow) nameBar.classList.remove('collapsed');
        perSlideReveal = false;
      }, nameDelay);
      currentLink = it.itemUrl || '#';
      openLinkHeader.onclick = ()=>{ if(currentLink && currentLink!=='#') window.open(currentLink,'_blank','noopener'); };
      downloadLink.href = it.imageUrl; downloadLink.download = (fileName||'image').replace(/^File:/,'');
    }catch{ next(); }
  }
  function next(){ showIndex((currIndex + 1) % items.length); }
  function prev(){ showIndex((currIndex - 1 + items.length) % items.length); }

  function startAutoplay(){ if(timer) clearInterval(timer); timer = setInterval(next, (window.__slideSeconds||2)*1000); autoplay = true; cornerPlayStop.textContent='‚èπÔ∏è'; cornerPlayStop.classList.add('playing'); leftRail.classList.add('playing'); }
  function stopAutoplay(){ if(timer) clearInterval(timer); timer=null; autoplay=false; cornerPlayStop.textContent='‚ñ∂Ô∏è'; cornerPlayStop.classList.remove('playing'); leftRail.classList.remove('playing'); }
  cornerPlayStop.addEventListener('click', ()=>{ autoplay? stopAutoplay() : startAutoplay(); });
  function toggleGlobalName(){ globalHideNames = !globalHideNames; hideAllNamesBtn.textContent = globalHideNames ? 'Show' : 'Hide'; nameBar.classList.toggle('collapsed', globalHideNames); }
  hideAllNamesBtn.addEventListener('click', toggleGlobalName);
  showThisNameBtn.addEventListener('click', ()=>{ if(globalHideNames){ perSlideReveal = true; nameBar.classList.remove('collapsed'); } });

  document.getElementById('zoneLeft').addEventListener('click', ()=>{ stopAutoplay(); prev(); });
  document.getElementById('zoneRight').addEventListener('click', ()=>{ stopAutoplay(); next(); });

  // ---------- Category UI (auto-apply with debounce)
  const grids = [
    { grid: document.getElementById('termGrid1'), input: document.getElementById('customTerm1'), add: document.getElementById('addTerm1') },
    { grid: document.getElementById('termGrid2'), input: document.getElementById('customTerm2'), add: document.getElementById('addTerm2') },
    { grid: document.getElementById('termGrid3'), input: document.getElementById('customTerm3'), add: document.getElementById('addTerm3') },
  ];
  ['clearSelBtn','clearSelBtn2','clearSelBtn3'].forEach(id=>{
    const b=document.getElementById(id);
    if(b) b.addEventListener('click', ()=>{ clearSelection(); debouncedApply(); });
  });

  function makeTermButton(label, gridEl){
    const btn=document.createElement('button');
    btn.type='button'; btn.className='termBtn'; btn.textContent=label; btn.dataset.term=label;
    btn.addEventListener('click', ()=>{
      btn.classList.toggle('selected');
      debouncedApply();
    });
    gridEl.appendChild(btn); return btn;
  }
  function clearSelection(){
    grids.forEach(g=> g.grid.querySelectorAll('.termBtn.selected').forEach(b=> b.classList.remove('selected')));
    items=[]; currIndex=-1; countBadge.textContent='0';
  }
  function selectedTerms(){
    const out=[]; grids.forEach(g=> g.grid.querySelectorAll('.termBtn.selected').forEach(b=> out.push(b.dataset.term||b.textContent.trim())));
    return out;
  }
  const presets = [
    'Norwegian celebs','Beatles','US celebrities','Norwegian politicians','Norwegian CEO','US CEO','World CEO','Music producers',
    "Models of the 50's","Models of the 80's",'famous movie characters','famous cartoon characters','objects','household objects','clutter home objects','cars',
    'actors 2025','singers 2024','bands 2024','scientists','historical figures in science','historical leaders','historical pioneers','cars of 2010','cars of 2025'
  ];
  (function populate(){
    const lists=[grids[0].grid,grids[1].grid,grids[2].grid];
    presets.forEach((p,i)=>{ const gi=Math.min(Math.floor(i/16),2); makeTermButton(p, lists[gi]); });
    // Auto-select ‚ÄúNorwegian celebs‚Äù
    Array.from(lists[0].children).forEach(b=>{ if(b.dataset.term==='Norwegian celebs') b.classList.add('selected'); });
  })();
  // Add custom
  grids.forEach(g=>{
    if(g.add && g.input && g.grid){
      g.add.addEventListener('click', ()=>{
        const v=(g.input.value||'').trim(); if(!v) return;
        makeTermButton(v, g.grid).classList.add('selected');
        g.input.value=''; debouncedApply();
      });
    }
  });

  // ---------- Data (Wikidata/Commons)
  function H(lines){ return `{ ?person wdt:P31 wd:Q5 ; ${lines.join(' ')} wdt:P18 ?image . BIND(?person AS ?entity) }`; }
  function F(lines){ return `{ ?person wdt:P18 ?image . ${lines.join(' ')} BIND(?person AS ?entity) }`; }
  function T(lines){ return `{ ?thing ${lines.join(' ')} wdt:P18 ?image . BIND(?thing AS ?entity) }`; }

  const CATEGORY_BLOCKS = {
    'Beatles': () => H([ 'wdt:P463 wd:Q1299 ;' ]),
    'Norwegian celebs': () => H([ 'wdt:P27 wd:Q20 ;' ]),
    'US celebrities': () => H([ 'wdt:P27 wd:Q30 ;' ]),
    'Norwegian politicians': () => H([ 'wdt:P27 wd:Q20 ;','wdt:P106 wd:Q82955 ;' ]),
    'Norwegian CEO': () => H([ 'wdt:P27 wd:Q20 ;','wdt:P39 wd:Q484876 ;' ]),
    'US CEO': () => H([ 'wdt:P27 wd:Q30 ;','wdt:P39 wd:Q484876 ;' ]),
    'World CEO': () => H([ 'wdt:P39 wd:Q484876 ;' ]),
    'Music producers': () => H([ 'wdt:P106 wd:Q183945 ;' ]),
    "Models of the 50's": () => `{ ?person wdt:P31 wd:Q5 ; wdt:P106 wd:Q4610556 ; wdt:P18 ?image .
      OPTIONAL { ?person wdt:P2031 ?start . } OPTIONAL { ?person wdt:P2032 ?end . }
      FILTER( (BOUND(?start) && year(?start) <= 1959) || (BOUND(?end) && year(?end) >= 1950) || (!BOUND(?start) && !BOUND(?end)) )
      BIND(?person AS ?entity) }`,
    "Models of the 80's": () => `{ ?person wdt:P31 wd:Q5 ; wdt:P106 wd:Q4610556 ; wdt:P18 ?image .
      OPTIONAL { ?person wdt:P2031 ?start . } OPTIONAL { ?person wdt:P2032 ?end . }
      FILTER( (BOUND(?start) && year(?start) <= 1989) || (BOUND(?end) && year(?end) >= 1980) || (!BOUND(?start) && !BOUND(?end)) )
      BIND(?person AS ?entity) }`,
    'famous movie characters': () => F([ ' ?person wdt:P31 wd:Q15773347 . ' ]),
    'famous cartoon characters': () => F([ ' { ?person wdt:P31 wd:Q15711870 . } UNION { ?person wdt:P31 wd:Q373494 . } ' ]),
    'objects': () => T([ ' ?thing wdt:P31/wdt:P279* wd:Q488383 . ' ]),
    'household objects': () => T([ ' { ?thing wdt:P31/wdt:P279* wd:Q478017 . } UNION { ?thing wdt:P31/wdt:P279* wd:Q1491801 . } UNION { ?thing wdt:P31/wdt:P279* wd:Q319541 . } ' ]),
    'clutter home objects': () => T([ ' { ?thing wdt:P31/wdt:P279* wd:Q1491801 . } UNION { ?thing wdt:P31/wdt:P279* wd:Q478017 . } ' ]),
    'cars': () => T([ ' { ?thing wdt:P31 wd:Q1420 . } UNION { ?thing wdt:P31 wd:Q3231690 . } ' ]),
    'actors 2025': () => H([ 'wdt:P106 wd:Q33999 ;' ]),
    'singers 2024': () => H([ 'wdt:P106 wd:Q177220 ;' ]),
    'bands 2024': () => T([ ' ?thing wdt:P31/wdt:P279* wd:Q215380 . ' ]), /* musical group */
    'scientists': () => H([ 'wdt:P106 wd:Q901 ; ' ]),
    'historical figures in science': () => H([ 'wdt:P106 wd:Q901 ; ' ]),
    'historical leaders': () => H([ 'wdt:P106 wd:Q82955 ; ' ]), /* using politician as proxy */
    'historical pioneers': () => H([ 'wdt:P106 wd:Q81096 ; ' ])  /* inventor as proxy */
  };

  function parseDynamicTerm(term){
    const t = term.toLowerCase();
    const year = t.match(/(\d{4})/);
    if (t.includes('cars') && year){
      const y = +year[1];
      return `{ ?thing wdt:P18 ?image . { ?thing wdt:P31 wd:Q3231690 . OPTIONAL { ?thing wdt:P571 ?inception . } FILTER(BOUND(?inception) && year(?inception) = ${y}) } BIND(?thing AS ?entity) }`;
    }
    if (t.includes('cars')) return CATEGORY_BLOCKS['cars']();
    if (t.includes('household')) return CATEGORY_BLOCKS['household objects']();
    if (t.includes('clutter')) return CATEGORY_BLOCKS['clutter home objects']();
    if (t.includes('objects')) return CATEGORY_BLOCKS['objects']();
    return null;
  }

  function buildSPARQLFromTerms(terms){
    const blocks = [];
    terms.forEach(raw=>{
      const label = (raw||'').trim();
      const fixed = CATEGORY_BLOCKS[label] || CATEGORY_BLOCKS[label.replace(/celbs/i,'celebs')] || CATEGORY_BLOCKS[label.replace(/us celebs/i,'US celebrities')] || CATEGORY_BLOCKS[label.replace(/us ceo/i,'US CEO')];
      if (fixed) { blocks.push(fixed()); return; }
      const dyn = parseDynamicTerm(label); if(dyn){ blocks.push(dyn); return; }
      // fallback: people with images
      blocks.push(H([]));
    });
    const union = blocks.join('\nUNION\n');
    return `SELECT ?entity ?entityLabel ?image WHERE {
      ${union}
      SERVICE wikibase:label { bd:serviceParam wikibase:language "nb,nn,no,en". }
    } LIMIT 300`;
  }

  async function sparqlQuery(query){
    const endpoint = 'https://query.wikidata.org/sparql';
    const body = new URLSearchParams(); body.set('query', query);
    const res = await fetch(endpoint, { method:'POST', mode:'cors',
      headers:{ 'Accept':'application/sparql-results+json','Content-Type':'application/x-www-form-urlencoded; charset=UTF-8' }, body });
    if(!res.ok){ const text = await res.text().catch(()=>'' ); throw new Error('WDQS '+res.status+' '+text.slice(0,120)); }
    return await res.json();
  }

  async function fetchWDFromTerms(terms){
    const data = await sparqlQuery(buildSPARQLFromTerms(terms));
    const rows = data.results.bindings || [];
    return rows.map(r=>{
      const name = r.entityLabel?.value || 'Untitled';
      const raw = r.image?.value || '';
      let fileTitle = 'File:';
      let imageUrl = '';
      if (raw.includes('Special:FilePath/')){
        imageUrl = raw + (raw.includes('?')? '&' : '?') + 'width=1600';
        try{ fileTitle = 'File:' + decodeURIComponent(raw.split('Special:FilePath/')[1].split('?')[0]); }catch{}
      } else {
        let fn = raw;
        try{ if(fn.startsWith('http')){ const u = new URL(fn); fn = decodeURIComponent(u.pathname.split('/').pop()); }}catch{}
        fn = fn.replace(/^.*File:/,''); if(!fn) return null;
        imageUrl = 'https://commons.wikimedia.org/wiki/Special:FilePath/' + encodeURIComponent(fn) + '?width=1600';
        fileTitle = 'File:'+fn;
      }
      const itemUrl = r.entity?.value || '#';
      return { name, imageUrl, fileTitle, itemUrl };
    }).filter(Boolean);
  }

  // ---------- Apply selection (auto)
  let applyTimer=null;
  function debouncedApply(){
    clearTimeout(applyTimer);
    applyTimer = setTimeout(applySelection, 400); // small debounce to avoid hammering WDQS
  }

  async function applySelection(){
    const chosen = selectedTerms();
    if(!chosen.length){
      items=[]; currIndex=-1; countBadge.textContent='0';
      return;
    }
    countBadge.textContent='Fetching‚Ä¶';
    try{
      let data = await fetchWDFromTerms(chosen);
      // random order only
      data = data.sort(()=>Math.random()-0.5);
      items = data;
      countBadge.textContent = `${items.length} photos`;
      if(!items.length) return;
      setPage(1);
      stopAutoplay(); showIndex(0); startAutoplay();
    }catch(e){
      countBadge.textContent='0';
      toast.textContent='Fetch error: '+e.message; toast.style.display='block'; setTimeout(()=> toast.style.display='none', 1800);
    }
  }

  // ---------- Populate defaults & kick off
  // Build grids are already populated above (presets)
  // Auto-apply initial selection (Norwegian celebs)
  debouncedApply();

  // ---------- Simple swipe page nav
  let s=null;
  document.addEventListener('touchstart', e=>{ const t=e.changedTouches[0]; s={x:t.clientX,y:t.clientY}; }, {passive:true});
  document.addEventListener('touchend', e=>{
    if(!s) return; const t=e.changedTouches[0];
    const dx=t.clientX-s.x, dy=t.clientY-s.y;
    if(Math.abs(dx)>40 && Math.abs(dy)<60){
      const active = tabs.findIndex(t=> t.page.classList.contains('active')) + 1;
      if(dx<0 && active<5) setPage(active+1);
      if(dx>0 && active>1) setPage(active-1);
    }
    s=null;
  }, {passive:true});
})();
</script>
</body>
</html>
