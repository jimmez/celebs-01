<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Celeb Slideshow ‚Äî Random Photo Fetcher</title>
<meta name="description" content="Slideshow that auto-fetches photos from Wikidata/Commons with reliable fetch, mobile swipe to pages, object/car categories, JSON import/export, bottom-left play/stop moved 20% up, and fine time controls (sec/ms)." />
<style>
:root{
  --bg:#0b0f14; --panel:#0f172a; --muted:#93a3b8; --fg:#e5eef7; --accent:#60a5fa; --ok:#34d399; --danger:#f87171; --warn:#fbbf24;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
  background:var(--bg); color:var(--fg);
  display:grid; grid-template-rows:auto 1fr auto
}
header{
  display:flex; gap:10px; align-items:center; padding:10px 12px;
  position:sticky; top:0; z-index:50; background:rgba(2,6,23,.6); backdrop-filter:blur(8px) saturate(1.2);
  border-bottom:1px solid rgba(255,255,255,.06)
}
h1{font-size:16px; margin:0}
.sp{flex:1}
.iconBtn{
  width:36px; height:36px; display:grid; place-items:center; border-radius:10px;
  border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); cursor:pointer
}
.btn{
  display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px;
  border:1px solid rgba(255,255,255,.1); background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
  color:var(--fg); cursor:pointer; user-select:none; font-weight:600
}
.btn.primary{border-color:rgba(96,165,250,.6); background:rgba(96,165,250,.15)}
.btn.ok{border-color:rgba(52,211,153,.6); background:rgba(52,211,153,.15)}
.btn.warn{border-color:rgba(251,191,36,.6); background:rgba(251,191,36,.15)}
.btn.danger{border-color:rgba(248,113,113,.7); background:rgba(248,113,113,.18)}
.smallBtn{padding:6px 10px; font-weight:700; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); cursor:pointer}

.badge{font-size:12px; padding:4px 8px; border:1px solid rgba(255,255,255,.12); border-radius:999px}

.tabs{display:flex; gap:8px; padding:8px 12px; border-bottom:1px solid rgba(255,255,255,.06); background:rgba(2,6,23,.35); overflow:auto}
.tab{padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.1); cursor:pointer; white-space:nowrap}
.tab[aria-selected="true"]{background:rgba(96,165,250,.15); border-color:rgba(96,165,250,.6)}

.page{display:none; height:100%}
.page.active{display:block}

.stage{
  position:relative; height:calc(100vh - 240px); min-height:360px; overflow:hidden; display:grid; place-items:center
}
.imgwrap{position:relative; width:100%; height:100%; display:grid; place-items:center}
img.photo{
  max-width:85%; max-height:75%; object-fit:contain; border-radius:18px; box-shadow:0 12px 36px rgba(0,0,0,.6)
}

/* Click/tap zones */
.hotzone{position:absolute; top:0; bottom:0}
.hotzone.left{left:0; width:33.333%}
.hotzone.right{right:0; width:66.667%}

/* Name/caption area */
.nameArea{
  position:absolute; left:50%; transform:translateX(-50%); bottom:24px;
  display:grid; gap:10px; place-items:center; width:min(92%, 820px)
}
/* Centered title only */
.nameBar{
  order:1; width:100%; background:rgba(2,6,23,.88);
  border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:12px 14px; text-align:center
}
.nameBar.collapsed{display:none}
.title{font-size:20px; font-weight:800}

.controlsRow{order:2; display:flex; gap:8px; flex-wrap:wrap; justify-content:center}
.linkRow{order:3; display:flex; gap:8px; justify-content:center}

.builder{padding:12px}
.hintRow{display:flex; gap:10px; align-items:center; margin-bottom:8px}
.hint{font-size:13px; color:var(--muted)}
.hintToggle{width:18px; height:18px; border-radius:4px; background:#334155; border:1px solid rgba(255,255,255,.2); cursor:pointer}

.grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(160px, 1fr)); gap:10px}
.termBtn{padding:12px 14px; border-radius:12px; background:#111827; border:1px solid rgba(255,255,255,.22); cursor:pointer; text-align:left; user-select:none; color:#fff}
.termBtn.selected{outline:2px solid var(--accent); background:#1f2937}
.termBtn.editing{outline:2px dashed var(--warn)}
.builderActions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; align-items:center}

footer{
  padding:10px 12px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; color:var(--muted);
  border-top:1px solid rgba(255,255,255,.06)
}
footer a{color:var(--ok); text-decoration:none}

.toast{
  position:fixed; right:16px; bottom:16px; background:rgba(2,6,23,.85); color:var(--fg);
  border:1px solid rgba(255,255,255,.09); padding:10px 12px; border-radius:12px; font-size:13px; display:none
}

/* Floating blue button + drawer */
.fab{position:fixed; right:16px; bottom:16px; width:56px; height:56px; border-radius:50%; background:#3b82f6; color:white; display:grid; place-items:center; font-size:22px; cursor:pointer; box-shadow:0 10px 24px rgba(0,0,0,.35); z-index:60}
.drawer{position:fixed; left:0; right:0; bottom:-270px; background:rgba(15,23,42,.96); border-top:1px solid rgba(255,255,255,.08); padding:12px; display:grid; gap:12px; transition:bottom .25s ease; z-index:55}
.drawer.open{bottom:0}
.quickRow{display:flex; gap:8px; flex-wrap:wrap}
.quickBtn{padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); color:#e5eef7; cursor:pointer; font-weight:700}

.playCorner{position:fixed; left:16px; bottom:20vh; z-index:65}
.debug{position:fixed; left:12px; bottom:60px; font-size:11px; color:#9fb7d6; opacity:.7}

.stepper{display:inline-flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid rgba(255,255,255,.14); border-radius:10px; background:rgba(255,255,255,.06)}
.stepper .stepVal{min-width:32px; text-align:center; font-weight:800}

@media (max-width:768px){
  .controls .btn, .controls label{display:none}
}
</style>
</head>
<body>
<header>
  <h1>üéûÔ∏è Celeb Slideshow</h1>
  <span class="badge" id="countBadge">Loading‚Ä¶</span>
  <div class="sp"></div>
  <button class="iconBtn" id="gearBtn" title="Settings (JSON import/export)">‚öôÔ∏è</button>
  <button class="iconBtn" id="nextTabBtn" title="Next page">‚û°Ô∏è</button>
</header>

<nav class="tabs" role="tablist">
  <button class="tab" role="tab" aria-controls="page1" aria-selected="true" id="tab1">Page 1: Slideshow</button>
  <button class="tab" role="tab" aria-controls="page2" aria-selected="false" id="tab2">Page 2: Categories A</button>
  <button class="tab" role="tab" aria-controls="page3" aria-selected="false" id="tab3">Page 3: Categories B</button>
  <button class="tab" role="tab" aria-controls="page4" aria-selected="false" id="tab4">Page 4: Categories C</button>
  <button class="tab" role="tab" aria-controls="page5" aria-selected="false" id="tab5">Page 5: Settings</button>
</nav>

<main>
  <section id="page1" class="page active" role="tabpanel" aria-labelledby="tab1">
    <div class="stage" id="stage">
      <div class="imgwrap" id="imgwrap"><div class="hint">Fetching photos‚Ä¶</div></div>
      <div class="hotzone left" id="zoneLeft" title="Previous"></div>
      <div class="hotzone right" id="zoneRight" title="Next"></div>

      <div class="nameArea">
        <!-- Centered title only -->
        <div class="nameBar" id="nameBar">
          <div class="title" id="personName">&nbsp;</div>
        </div>

        <!-- Controls below the title -->
        <div class="controlsRow">
          <button class="smallBtn" id="nameToggle">Hide names</button>
          <button class="smallBtn" id="showOnceBtn">Show (this photo)</button>
        </div>

        <!-- Compact link button only (no long URL text) -->
        <div class="linkRow">
          <a class="smallBtn" id="linkBtn" href="#" target="_blank" rel="noopener">Link</a>
          <a class="smallBtn" id="downloadBtn" href="#" download>Download</a>
        </div>
      </div>
    </div>
  </section>

  <section id="page2" class="page" role="tabpanel" aria-labelledby="tab2">
    <div class="builder">
      <div class="hintRow"><div class="hintToggle" id="hintToggle2"></div><div class="hint" id="hint2">Tap to select (blue). Triple-click to edit. Apply clears cache and loads only selected. <a href="#" id="linkP3">Go to Page 3</a> ‚Ä¢ <a href="#" id="linkP4">Page 4</a> ‚Ä¢ <a href="#" id="linkP5">Settings</a> ‚Ä¢ <a href="#" id="linkBack1">Back to Page 1</a></div></div>
      <div class="grid" id="termGrid1"></div>
      <div class="builderActions">
        <input type="text" id="customTerm1" placeholder="Add a custom term‚Ä¶ (e.g., cars of 2010)" />
        <button class="btn ok" id="addTerm1">Add</button>
        <button class="btn primary" id="applyBtn">Apply selection</button>
        <button class="btn danger" id="clearSelBtn">Clear selection</button>
        <span class="hint">Mode:</span>
        <button class="btn" id="modeRandom" aria-pressed="true">Random photos</button>
        <button class="btn" id="modeFixed" aria-pressed="false">Same sequence</button>
      </div>
    </div>
  </section>

  <section id="page3" class="page" role="tabpanel" aria-labelledby="tab3">
    <div class="builder">
      <div class="hintRow"><div class="hintToggle" id="hintToggle3"></div><div class="hint" id="hint3"><a href="#" id="linkP2">Page 2</a> ‚Ä¢ <a href="#" id="linkP4b">Page 4</a> ‚Ä¢ <a href="#" id="linkP5b">Settings</a> ‚Ä¢ <a href="#" id="linkBack2">Back to Page 1</a></div></div>
      <div class="grid" id="termGrid2"></div>
      <div class="builderActions">
        <input type="text" id="customTerm2" placeholder="Add a custom term‚Ä¶" />
        <button class="btn ok" id="addTerm2">Add</button>
      </div>
    </div>
  </section>

  <section id="page4" class="page" role="tabpanel" aria-labelledby="tab4">
    <div class="builder">
      <div class="hintRow"><div class="hintToggle" id="hintToggle4"></div><div class="hint" id="hint4"><a href="#" id="linkP2c">Page 2</a> ‚Ä¢ <a href="#" id="linkP3c">Page 3</a> ‚Ä¢ <a href="#" id="linkP5c">Settings</a> ‚Ä¢ <a href="#" id="linkBack3">Back to Page 1</a></div></div>
      <div class="grid" id="termGrid3"></div>
      <div class="builderActions">
        <input type="text" id="customTerm3" placeholder="Add a custom term‚Ä¶" />
        <button class="btn ok" id="addTerm3">Add</button>
      </div>
    </div>
  </section>

  <section id="page5" class="page" role="tabpanel" aria-labelledby="tab5">
    <div class="builder">
      <div class="hintRow"><div class="hintToggle" id="hintToggle5"></div><div class="hint" id="hint5">Settings: Export/Import categories as JSON. <a href="#" id="linkBack4">Back to Page 1</a></div></div>
      <div style="display:grid; gap:10px; max-width:840px">
        <button class="btn primary" id="exportBtn">Export categories ‚Üí JSON</button>
        <textarea id="jsonBox" placeholder='Paste JSON here to import‚Ä¶'></textarea>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn ok" id="importBtn">Import JSON</button>
          <button class="btn warn" id="resetBtn">Reset to defaults</button>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>
  <div>PC keys: Right-side ‚Üí <strong>Next</strong> (except <kbd>P</kbd> = play/pause). Left-side ‚Üí <strong>Previous</strong> (except <kbd>S</kbd> = name). <kbd>Space</kbd>/<kbd>P</kbd> = play/pause. Arrows work. While typing/renaming, hotkeys are disabled. Mobile: swipe left on Page 1 to open Page 2, then left again to Page 3; swipe right from category pages to return.</div>
  <div class="sp"></div>
  <a href="#" id="downloadLink" title="Download current image">Download</a>
</footer>

<!-- Bottom-left Play/Stop (20% up) -->
<div class="playCorner"><button class="btn primary" id="cornerPlayStop">‚èØÔ∏è Play/Stop</button></div>

<!-- Floating blue button to toggle drawers -->
<button class="fab" id="speedFab" title="Speed & Name reveal">‚óè</button>

<div class="drawer" id="speedDrawer">
  <div><strong>Slide speed</strong></div>
  <div class="quickRow" id="speedRow">
    <!-- Removed 1s and 5s as requested -->
    <button class="quickBtn" data-s="0.1">0.1s</button>
    <button class="quickBtn" data-s="0.2">0.2s</button>
    <button class="quickBtn" data-s="0.5">0.5s</button>
    <button class="quickBtn" data-s="0.7">0.7s</button>
    <button class="quickBtn" data-s="1.5">1.5s</button>
    <button class="quickBtn" data-s="2">2s</button>
    <button class="quickBtn" data-s="10">10s</button>
  </div>

  <div><strong>Fine tune speed</strong> <span class="hint">(seconds & milliseconds, ms in 200ms steps)</span></div>
  <div class="quickRow" id="fineRow">
    <div class="stepper" data-type="sec">
      <button class="quickBtn" data-delta="-1">‚àí</button>
      <span class="stepVal" id="fineSec">2</span><span class="hint"> s</span>
      <button class="quickBtn" data-delta="1">Ôºã</button>
    </div>
    <div class="stepper" data-type="ms">
      <button class="quickBtn" data-delta="-200">‚àí</button>
      <span class="stepVal" id="fineMs">0</span><span class="hint"> ms</span>
      <button class="quickBtn" data-delta="200">Ôºã</button>
    </div>
    <div class="stepperDisplay"><span class="hint">Total:</span> <strong id="fineTotal">2.0s</strong></div>
  </div>

  <div><strong>Name reveal delay</strong> <span class="hint">(same fine-tune: sec ¬±1 / ms ¬±200)</span></div>
  <div class="quickRow" id="nameFineRow">
    <div class="stepper" data-type="nsec">
      <button class="quickBtn" data-delta="-1">‚àí</button>
      <span class="stepVal" id="nameFineSec">0</span><span class="hint"> s</span>
      <button class="quickBtn" data-delta="1">Ôºã</button>
    </div>
    <div class="stepper" data-type="nms">
      <button class="quickBtn" data-delta="-200">‚àí</button>
      <span class="stepVal" id="nameFineMs">700</span><span class="hint"> ms</span>
      <button class="quickBtn" data-delta="200">Ôºã</button>
    </div>
    <div class="stepperDisplay"><span class="hint">Total:</span> <strong id="nameFineTotal">0.7s</strong></div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="debug" id="debug"></div>

<script>
(function(){
  // Elements
  const stage = document.getElementById('stage');
  const wrap = document.getElementById('imgwrap');
  const nameBar = document.getElementById('nameBar');
  const nameToggle = document.getElementById('nameToggle');
  const showOnceBtn = document.getElementById('showOnceBtn');
  const personName = document.getElementById('personName');
  const linkBtn = document.getElementById('linkBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const countBadge = document.getElementById('countBadge');
  const downloadLink = document.getElementById('downloadLink');
  const toast = document.getElementById('toast');
  const speedFab = document.getElementById('speedFab');
  const speedDrawer = document.getElementById('speedDrawer');
  const debug = document.getElementById('debug');
  const gearBtn = document.getElementById('gearBtn');
  const nextTabBtn = document.getElementById('nextTabBtn');
  const cornerPlayStop = document.getElementById('cornerPlayStop');

  // Tabs
  const tabs = [1,2,3,4,5].map(i=>({ tab: document.getElementById('tab'+i), page: document.getElementById('page'+i) }));
  function setPage(idx){
    tabs.forEach((t,i)=>{
      const active=(i+1)===idx;
      t.page.classList.toggle('active', active);
      t.tab.setAttribute('aria-selected', String(active));
    });
  }
  tabs.forEach((t,i)=> t.tab.addEventListener('click', ()=> setPage(i+1)));
  gearBtn.addEventListener('click', ()=> setPage(5));
  nextTabBtn.addEventListener('click', ()=>{
    const active = tabs.findIndex(t=> t.page.classList.contains('active')) + 1;
    setPage(active%5 + 1);
  });

  // Page links
  const link = (id, to)=> document.getElementById(id)?.addEventListener('click', (e)=>{ e.preventDefault(); setPage(to); });
  link('linkP3',3); link('linkP4',4); link('linkP5',5); link('linkBack1',1);
  link('linkP2',2); link('linkP4b',4); link('linkP5b',5); link('linkBack2',1);
  link('linkP2c',2); link('linkP3c',3); link('linkP5c',5); link('linkBack3',1); link('linkBack4',1);

  // Grids & settings
  const grids = [
    { grid: document.getElementById('termGrid1'), input: document.getElementById('customTerm1'), add: document.getElementById('addTerm1'), hint: document.getElementById('hint2'), toggle: document.getElementById('hintToggle2') },
    { grid: document.getElementById('termGrid2'), input: document.getElementById('customTerm2'), add: document.getElementById('addTerm2'), hint: document.getElementById('hint3'), toggle: document.getElementById('hintToggle3') },
    { grid: document.getElementById('termGrid3'), input: document.getElementById('customTerm3'), add: document.getElementById('addTerm3'), hint: document.getElementById('hint4'), toggle: document.getElementById('hintToggle4') },
  ];
  const applyBtn = document.getElementById('applyBtn');
  const clearSelBtn = document.getElementById('clearSelBtn');
  const modeRandom = document.getElementById('modeRandom');
  const modeFixed = document.getElementById('modeFixed');
  const jsonBox = document.getElementById('jsonBox');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const resetBtn = document.getElementById('resetBtn');

  // State
  let items = [];
  let timer=null;
  let autoplay=true;
  let currIndex=-1;
  let lastKeyTime=0;
  let fixedOrder=false;
  let mobileSwipeStart=null;

  // Name reveal: fine-tune values (sec & ms, with ¬±200ms)
  window.__nameFineSec = 0;
  window.__nameFineMs  = 700;

  // Slide speed: default and fine tune values
  window.__slideSeconds = 2;
  window.__fineSec = 2;
  window.__fineMs  = 0;

  // Name visibility: global hide flag & per-photo override
  let hideAllNames = false;
  let showOverride = false;

  function msFromFine(sec, ms){ return Math.max(0, (Number(sec)||0)*1000 + (Number(ms)||0)); }
  function secondsFromFine(sec, ms){ return msFromFine(sec, ms) / 1000; }

  // ====== Wikidata helpers (same as before, kept intact) ======
  function blockHumanWithImage(lines){ return `{ ?person wdt:P31 wd:Q5 ; ${lines.join(' ')} wdt:P18 ?image . }`; }
  function blockFictionalWithImage(lines){ return `{ ?person wdt:P18 ?image . ${lines.join(' ')} }`; }
  function blockThingWithImage(lines){ return `{ ?thing ${lines.join(' ')} wdt:P18 ?image . }`; }

  const CATEGORY_BLOCKS = {
    'Beatles': () => blockHumanWithImage([ 'wdt:P463 wd:Q1299 ;' ]),
    'Norwegian celebs': () => blockHumanWithImage([ 'wdt:P27 wd:Q20 ;' ]),
    'US celebs': () => blockHumanWithImage([ 'wdt:P27 wd:Q30 ;' ]),
    'Norwegian politicians': () => blockHumanWithImage([ 'wdt:P27 wd:Q20 ;','wdt:P106 wd:Q82955 ;' ]),
    'Norwegian ceo': () => blockHumanWithImage([ 'wdt:P27 wd:Q20 ;','wdt:P39 wd:Q484876 ;' ]),
    'US ceo': () => blockHumanW
